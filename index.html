<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMF Anal√Ωza | N√°jdite svoj potenci√°l</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400&display=swap');
        
        :root {
            --google-blue: #4285F4;
            --google-red: #EA4335;
            --google-green: #34A853;
            --google-yellow: #FBBC04;
            --text-dark: #202124;
            --text-light: #5f6368;
            --border-color: #dfe1e5;
            --background-light: #f8f9fa;
            --background-color: #f0f2f5;
            --primary-color: var(--google-green);
            --secondary-color: var(--google-blue);
            --card-bg-color: #ffffff;
            --star-color: var(--google-yellow);
            --danger-color: var(--google-red);
            --score-red: var(--google-red);
            --score-orange: var(--google-yellow);
            --score-green: var(--google-green);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Roboto', sans-serif;
            color: var(--text-dark);
            background-color: var(--background-light);
            overflow: hidden; /* Zabr√°ni scrollbarom z pl√°tna */
        }
        
        /* --- STYLY PRO √öVODN√ç OBRAZOVKU --- */
        #welcome-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100%;
            overflow: hidden;
            position: relative;
            transition: opacity 0.5s ease-out;
        }

        #particle-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .welcome-header {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            width: 100%;
            padding: 30px 40px;
        }

        .welcome-logo {
            width: 120px;
            height: auto;
        }
        
        .welcome-content {
            position: relative;
            z-index: 5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 50px;
            
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            max-width: 850px;
            width: 90%;
        }
        .welcome-content h1 {
            font-family: 'Google Sans', sans-serif;
            font-size: 3.2rem;
            font-weight: 700;
            margin-bottom: 16px;
            max-width: 750px;
            color: var(--text-dark);
            line-height: 1.2;
        }
        
        .welcome-content .subtitle {
            font-size: 1.25rem;
            color: var(--text-light);
            margin-bottom: 40px;
            max-width: 650px;
            line-height: 1.7;
        }
        
        .search-container { 
            display: flex; 
            align-items: center; 
            background: #fff; 
            border: 1px solid var(--border-color); 
            border-radius: 30px; 
            width: 100%; 
            max-width: 600px; 
            padding: 12px 24px; 
            box-shadow: 0 1px 6px rgba(32,33,36,.28); 
            transition: box-shadow 0.2s; 
        }
        .search-container:hover, .search-container:focus-within { 
            box-shadow: 0 4px 12px rgba(32,33,36,.2);
        }
        .search-container i { 
            font-size: 1.2rem; 
            color: var(--text-light); 
            margin-right: 12px; 
        }
        .search-container input { 
            width:100%; 
            flex-grow: 1; 
            border: none; 
            outline: none; 
            font-size: 1.1rem; 
            font-family: 'Roboto', sans-serif; 
            background: transparent; 
        }

        @media (max-width: 768px) {
            .welcome-content h1 {
                font-size: 2.5rem;
            }
            .welcome-content .subtitle {
                font-size: 1.1rem;
            }
            .welcome-content {
                padding: 40px 25px;
            }
        }
        
        /* --- STYLY PRO SEKCI S V√ùSLEDKY ANAL√ùZY --- */
        .app-container { max-width: 1200px; margin: 20px auto; padding:20px; }
        .hidden { display: none !important; }
        .spinner { text-align: center; padding: 40px; }
        
        .analysis-layout { display: grid; grid-template-columns: minmax(350px, 1.5fr) 1fr 0.8fr; gap: 25px; align-items: flex-start; }
        @media (max-width: 900px) { .analysis-layout { grid-template-columns: 1fr; } }
        
        .analysis-top-panel { background: var(--card-bg-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 25px; overflow: hidden; padding: 0; position: relative; }
        .top-panel-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; filter: brightness(0.6) blur(1.5px); }
        .top-panel-content { position: absolute; top: 0; left: 0; z-index: 3; color: white; height: 100%; width: 100%; padding: 25px; display: flex; flex-direction: column; justify-content: space-between; }
        .top-panel-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px; }
        .company-info { display: flex; flex-direction: column; gap: 15px; align-items: flex-start; }
        .company-details-group { display: flex; align-items: center; gap: 15px; }
        .company-name-section h2 { font-size: 2.2em; margin: 0; line-height: 1.2; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .status-button { display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 20px; font-size: 0.9em; font-weight: 500; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .verified-icon { position: relative; font-size: 2.5em; transition: color 0.4s; margin-right: -5px; }
        .verified-icon .fa-stack-1x { font-size: 0.5em; color: white; }
        .company-actions-block { display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        .company-actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 0; justify-content: flex-end; }
        .btn { padding: 10px 18px; font-size: 0.9em; border-radius: 8px; background-color: var(--google-blue); color: white; text-decoration: none; display: inline-flex; align-items: center; border: none; cursor: pointer; }
        .btn:hover { background-color: #3367D6; box-shadow: 0 6px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .btn-green { background-color: var(--google-green); }
        .btn-green:hover { background-color: #2e8b57; }
        .btn-sm { padding: 5px 10px; font-size: 0.8em; }
        .analysis-widget { background: var(--card-bg-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 25px; }
        .analysis-widget h3 { font-size: 1.2em; border-bottom: 1px solid #f0f0f0; margin: -25px -25px 20px -25px; padding: 15px 25px; }
        .analysis-widget h3 i { margin-right: 10px; color: var(--primary-color); }
        .details-list { list-style: none; }
        .details-list li { padding: 12px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; }
        .details-list li:last-child { border-bottom: none; }
        .details-list li > strong { font-weight: 500; flex-shrink: 0; color: var(--text-dark); }
        .details-list .value-col { text-align: right; color: var(--text-light); word-break: break-word; }
        .details-list .missing { color: var(--danger-color); font-style: italic; }
        .details-list .present { color: var(--google-green); }
        .details-list h4 { margin-top: 15px; color: var(--primary-color); text-align: left; width: 100%; border-top: 1px solid #e0e0e0; padding-top: 15px; }
        .details-list .toggle-btn { background: none; border: none; color: var(--secondary-color); cursor: pointer; font-size: 1rem; display: flex; align-items: center; gap: 5px; transition: color 0.2s; }
        .details-list .toggle-btn:hover { text-decoration: underline; }
        .details-list .toggle-btn .fas { transition: transform 0.2s; }
        .details-list .toggle-btn.expanded .fas { transform: rotate(180deg); }
        #manual-analysis-widget .manual-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .checklist-group { margin-bottom: 20px; }
        .checklist-group h4 { color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 10px; display: flex; align-items: center; font-size: 1.05em; }
        .checklist-group h4 i { margin-right: 10px; }
        .check-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0; font-size: 0.9em; }
        .check-item label { flex-grow: 1; user-select: none; line-height: 1.4; white-space: normal; text-align: left; max-width: calc(100% - 40px); }
        .check-item input[type="checkbox"] { width: 1.5em; height: 1.5em; cursor: pointer; flex-shrink: 0; }
        #score-widget { text-align: center; position: sticky; top: 20px; z-index: 10; }
        #score-widget .score-circle-wrapper { display: flex; flex-direction: column; align-items: center; }
        #score-widget .score-circle { position: relative; width: 180px; height: 180px; border-radius: 50%; background: conic-gradient(var(--score-green) 0deg, #e9ecef 0deg); display: flex; justify-content: center; align-items: center; }
        #score-widget .score-circle::before { content: ''; position: absolute; width: 150px; height: 150px; background: #fff; border-radius: 50%; }
        #score-widget .score-value { position: relative; font-size: 3em; font-weight: 700; color: var(--score-green); }
        .score-breakdown-toggle { cursor: pointer; font-weight: 500; color: var(--secondary-color); margin-top: 15px; display: inline-flex; align-items: center; user-select: none; transition: color 0.2s; }
        .score-breakdown-toggle:hover { color: var(--google-blue); }
        .score-breakdown-toggle i { margin-left: 8px; transition: transform 0.2s; }
        .score-breakdown-toggle.expanded i { transform: rotate(180deg); }
        .score-breakdown-list { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; padding-top: 0; }
        .score-breakdown-list.show { max-height: 1000px; padding-top: 15px; }
        .score-breakdown-list ul { padding: 0; margin: 0; list-style: none; }
        .score-breakdown-list li { display: flex; align-items: center; justify-content: flex-start; padding: 4px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; }
        .score-breakdown-list li i { width: 20px; flex-shrink: 0; margin-right: 10px; }
        .score-breakdown-list li span { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; }
        .score-breakdown-list .earned { color: var(--google-green); }
        .score-breakdown-list .missed { color: var(--danger-color); }
        .rating-info { display: flex; align-items: center; color: white; font-size: 1.1em; text-shadow: 1px 1px 2px rgba(0,0,0,0.4); }
        .rating-info i { margin-right: 5px; color: var(--star-color); letter-spacing: 2px; font-size: 1.2em; }
        .pac-container { z-index: 1050 !important; }
        @media (max-width: 900px) { .top-panel-header-content { max-width: 100%; } }
        #floating-warning-bar { position: fixed; bottom: 20px; right: 20px; width: 280px; height: 280px; background-color: var(--danger-color); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 10px; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        #floating-warning-bar ul { list-style: none; padding: 0; margin-top: 15px; }
        #floating-warning-bar li { margin-bottom: 8px; font-size: 0.9em; line-height: 1.4; }
        #floating-warning-bar.visible { opacity: 1; visibility: visible; }
        #floating-warning-bar .close-btn { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; margin-left: auto; opacity: 0.8; transition: opacity 0.2s; }
        #floating-warning-bar .close-btn:hover { opacity: 1; }
        #floating-warning-bar h4 { margin: 0; font-size: 1.1em; display: flex; align-items: center; gap: 10px; }
        #floating-warning-bar p { font-size: 0.9em; margin: 0; opacity: 0.8; line-height: 1.4; }
        #company-details-box { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); padding: 15px 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);}

        /* --- PLOVOUCE TLAƒåIDL√Å --- */
        #floating-new-analysis-btn { position: fixed; right: 30px; bottom: 30px; z-index: 1001; background-color: var(--google-blue); color: white; border: none; border-radius: 50px; padding: 15px 25px; cursor: pointer; box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        #floating-new-analysis-btn:hover { transform: scale(1.05); background-color: #3367D6; }
        #floating-comparison-btn { position: fixed; right: 30px; bottom: 95px; z-index: 1001; background-color: var(--google-green); color: white; border: none; border-radius: 50px; padding: 15px 25px; cursor: pointer; box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        #floating-comparison-btn:hover { transform: scale(1.05); background-color: #2e8b57; }
        #floating-back-btn { position: fixed; left: 30px; bottom: 30px; z-index: 1001; border-radius: 50px; padding: 15px 25px; }
        #floating-solution-btn { position: fixed; right: 30px; bottom: 95px; z-index: 1001; border-radius: 50px; padding: 15px 25px; }
        #floating-back-to-comparison-btn { position: fixed; left: 30px; bottom: 30px; z-index: 1001; border-radius: 50px; padding: 15px 25px; background-color: var(--text-light); }
        #floating-back-to-comparison-btn:hover { background-color: #70757a; }

        /* --- NOV√â STYLY PRO N√ÅVRH ≈òE≈†EN√ç --- */
        #solution-proposal-container .solution-header { text-align: center; margin-bottom: 30px; }
        #solution-proposal-container .solution-header h2 { font-size: 2.2em; margin-bottom: 10px; }
        #solution-proposal-container .solution-header p { font-size: 1.1em; color: var(--text-light); }
        .solution-category { margin-bottom: 35px; }
        .solution-category h3 { font-size: 1.5em; color: var(--text-dark); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .recommendation-card { background: var(--card-bg-color); border-left: 5px solid var(--google-blue); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 25px; margin-bottom: 20px; display: grid; grid-template-columns: 50px 1fr; gap: 15px; align-items: start; }
        .recommendation-card.critical { border-left-color: var(--danger-color); }
        .recommendation-icon { font-size: 2em; color: var(--google-blue); grid-row: 1 / span 2; display: flex; justify-content: center; align-items: flex-start; padding-top: 5px; }
        .recommendation-card.critical .recommendation-icon { color: var(--danger-color); }
        .recommendation-title { font-size: 1.2em; font-weight: 700; margin: 0 0 15px 0; }
        .recommendation-content h4 { font-size: 1em; font-weight: 500; color: var(--text-dark); margin-top: 0; margin-bottom: 8px; }
        .recommendation-content p { line-height: 1.6; color: var(--text-light); font-size: 0.95em; margin: 0; }
        .recommendation-content .why { margin-bottom: 15px; }
        .congrats-message { text-align: center; padding: 50px; background: var(--card-bg-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .congrats-message .fa-check-circle { font-size: 4em; color: var(--google-green); margin-bottom: 20px; }
        .congrats-message h2 { font-size: 2em; margin-bottom: 10px; }
        .congrats-message p { font-size: 1.1em; color: var(--text-light); }

    </style>
</head>
<body>
    
    <main id="welcome-screen">
        <canvas id="particle-canvas"></canvas>
        <header class="welcome-header">
             <img src="https://viewcz.com/images/svg/head-logo.svg" alt="ViewCZ Logo" class="welcome-logo">
        </header>
        <div class="welcome-content">
            <h1>Odhaƒæte pln√Ω potenci√°l svojho firemn√©ho profilu</h1>
            <p class="subtitle">V digit√°lnom svete je va≈°a vizitka na Map√°ch Google kƒæ√∫ƒçov√°. N√°≈° n√°stroj vykon√° hƒ∫bkov√∫ anal√Ωzu, porovn√° v√°s s konkurenciou a uk√°≈æe v√°m cestu k lep≈°√≠m v√Ωsledkom.</p>
            <div class="search-container">
                 <i class="fas fa-search"></i>
                 <input type="text" id="gmf-input" placeholder="Zadajte n√°zov a adresu va≈°ej firmy...">
            </div>
        </div>
    </main>
    
    <div class="app-container hidden" id="analysis-container"></div>
    <div class="app-container hidden" id="competitor-comparison-container"></div>
    <!-- NOV√ù KONTEJNER PRO N√ÅVRH ≈òE≈†EN√ç -->
    <div class="app-container hidden" id="solution-proposal-container"></div>

    <div id="floating-warning-bar" class="hidden">
        <div>
            <h4><i class="fas fa-exclamation-triangle"></i> Kritick√Ω nedostatok</h4>
            <ul>
                <li>‚ö†Ô∏è Riziko prevzatia profilu</li>
                <li>üö´ Obmedzen√© mo≈ænosti spr√°vy</li>
                <li>üìâ Hor≈°ia poz√≠cia vo vyhƒæad√°van√≠ a map√°ch</li>
                <li>‚ùå Ni≈æ≈°ia d√¥veryhodnos≈• u z√°kazn√≠kov</li>
                <li>üìä Obmedzen√Ω pr√≠stup k analytik√°m a funkci√°m</li>
            </ul>
        </div>
        <button class="close-btn">√ó</button>
    </div>
    
    <div id="map-service-container" style="display:none"></div>

    <!-- Pl√°vaj√∫ce tlaƒçidl√° -->
    <button id="floating-new-analysis-btn" class="btn hidden">
        <i class="fas fa-search-plus"></i> Nov√° anal√Ωza
    </button>
    <button id="floating-comparison-btn" class="btn btn-green hidden">
        <i class="fas fa-chart-bar"></i> Porovnanie s konkurenciou <i class="fas fa-arrow-right" style="margin-left: 8px;"></i>
    </button>
    <button id="floating-back-btn" class="btn hidden">
        <i class="fas fa-arrow-left"></i> Sp√§≈• na anal√Ωzu
    </button>
    <button id="floating-solution-btn" class="btn btn-green hidden">
        <i class="fas fa-lightbulb"></i> N√°vrh rie≈°enia <i class="fas fa-arrow-right" style="margin-left: 8px;"></i>
    </button>
    <!-- NOV√â TLAƒåIDLO SP√Ñ≈§ -->
    <button id="floating-back-to-comparison-btn" class="btn hidden">
        <i class="fas fa-arrow-left"></i> Sp√§≈• na porovnanie
    </button>


    <script> const API_KEY = "AIzaSyAnwJg7hLl05s-usDuSvrcM3nnu90dRczI"; </script>
    <script id="google-maps-script" async defer></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const $ = (s) => document.querySelector(s);
            const $$ = (s) => document.querySelectorAll(s);

            let placesService, currentPlaceDetails = null, competitors = [];
            let streetViewService = null;
            const gmfInput = $('#gmf-input');
            const welcomeScreen = $('#welcome-screen');
            const analysisContainer = $('#analysis-container');
            const competitorComparisonContainer = $('#competitor-comparison-container');
            const solutionProposalContainer = $('#solution-proposal-container');
            
            const floatingNewAnalysisBtn = $('#floating-new-analysis-btn');   
            const floatingComparisonBtn = $('#floating-comparison-btn');
            const floatingBackBtn = $('#floating-back-btn');
            const floatingSolutionBtn = $('#floating-solution-btn');
            const floatingBackToComparisonBtn = $('#floating-back-to-comparison-btn');

            const placeDetailsFields = ['place_id', 'name', 'formatted_address', 'address_components', 'rating', 'user_ratings_total', 'types', 'url', 'geometry', 'opening_hours', 'website', 'formatted_phone_number', 'photos', 'plus_code', 'reviews', 'price_level', 'editorial_summary', 'business_status' ];
            let manualChecklistState = {};
            let competitorsState = {};
            const MAX_COMPETITORS = 2;
            const RANK_COLORS = ['var(--google-green)', '#86B386', 'var(--google-yellow)', 'var(--google-red)'];
            
            // --- Particle Network Animation ---
            const canvas = document.getElementById('particle-canvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                let particlesArray;

                const mouse = { x: null, y: null, radius: (canvas.height/120) * (canvas.width/120) }

                window.addEventListener('mousemove', function(event){
                    mouse.x = event.x;
                    mouse.y = event.y;
                });

                class Particle {
                    constructor(x, y, directionX, directionY, size, color) {
                        this.x = x; this.y = y; this.directionX = directionX; this.directionY = directionY; this.size = size; this.color = color;
                    }
                    draw() {
                        ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false); ctx.fillStyle = this.color; ctx.fill();
                    }
                    update() {
                        if (this.x > canvas.width || this.x < 0) { this.directionX = -this.directionX; }
                        if (this.y > canvas.height || this.y < 0) { this.directionY = -this.directionY; }
                        let dx = mouse.x - this.x; let dy = mouse.y - this.y; let distance = Math.sqrt(dx*dx + dy*dy);
                        if (distance < mouse.radius + this.size){
                            if(mouse.x < this.x && this.x < canvas.width - this.size * 10){ this.x += 5; }
                            if(mouse.x > this.x && this.x > this.size * 10){ this.x -= 5; }
                            if(mouse.y < this.y && this.y < canvas.height - this.size * 10){ this.y += 5; }
                            if(mouse.y > this.y && this.y > this.size * 10){ this.y -= 5; }
                        }
                        this.x += this.directionX; this.y += this.directionY; this.draw();
                    }
                }

                function initParticles() {
                    particlesArray = [];
                    let numberOfParticles = (canvas.height * canvas.width) / 9000;
                    for (let i = 0; i < numberOfParticles; i++) {
                        let size = (Math.random() * 2) + 1;
                        let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2);
                        let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2);
                        let directionX = (Math.random() * 0.4) - 0.2;
                        let directionY = (Math.random() * 0.4) - 0.2;
                        let color = 'rgba(150, 150, 150, 0.4)';
                        particlesArray.push(new Particle(x, y, directionX, directionY, size, color));
                    }
                }

                function connect(){
                    let opacityValue = 1;
                    for(let a = 0; a < particlesArray.length; a++){
                        for (let b = a; b < particlesArray.length; b++){
                            let distance = ((particlesArray[a].x - particlesArray[b].x) * (particlesArray[a].x - particlesArray[b].x)) + ((particlesArray[a].y - particlesArray[b].y) * (particlesArray[a].y - particlesArray[b].y));
                            if (distance < (canvas.width/7) * (canvas.height/7)){
                                opacityValue = 1 - (distance/20000);
                                ctx.strokeStyle = `rgba(170, 170, 170, ${opacityValue})`;
                                ctx.lineWidth = 1;
                                ctx.beginPath(); ctx.moveTo(particlesArray[a].x, particlesArray[a].y); ctx.lineTo(particlesArray[b].x, particlesArray[b].y); ctx.stroke();
                            }
                        }
                    }
                }
                
                function animateParticles() {
                    requestAnimationFrame(animateParticles);
                    ctx.clearRect(0,0,innerWidth, innerHeight);
                    for (let i = 0; i < particlesArray.length; i++) { particlesArray[i].update(); }
                    connect();
                }

                window.addEventListener('resize', function(){
                    canvas.width = innerWidth; canvas.height = innerHeight;
                    mouse.radius = (canvas.height/120) * (canvas.width/120);
                    initParticles();
                });

                window.addEventListener('mouseout', function(){ mouse.x = undefined; mouse.y = undefined; });

                initParticles();
                animateParticles();
            }


            const hideWarningBar = () => {
                const floatingWarningBar = $('#floating-warning-bar');
                if (floatingWarningBar.classList.contains('visible')) {
                    floatingWarningBar.classList.remove('visible');
                    floatingNewAnalysisBtn.style.bottom = '30px';
                    floatingComparisonBtn.style.bottom = '95px';
                }
            }

            // --- RESET DO V√ùCHODZIEHO STAVU ---
            const resetToWelcomeScreen = () => {
                analysisContainer.classList.add('hidden');
                competitorComparisonContainer.classList.add('hidden');
                solutionProposalContainer.classList.add('hidden');
                floatingNewAnalysisBtn.classList.add('hidden');
                floatingComparisonBtn.classList.add('hidden');
                floatingBackBtn.classList.add('hidden');
                floatingSolutionBtn.classList.add('hidden');
                floatingBackToComparisonBtn.classList.add('hidden');
                const floatingWarningBar = $('#floating-warning-bar');
                floatingWarningBar.classList.add('hidden');
                floatingWarningBar.classList.remove('visible');

                welcomeScreen.classList.remove('hidden');
                
                welcomeScreen.style.opacity = 1;

                gmfInput.value = '';
                currentPlaceDetails = null;
                competitors = [];
                manualChecklistState = {};
                competitorsState = {};
                
                document.body.style.overflow = '';
            };

            // Tlaƒçidl√°
            floatingNewAnalysisBtn.addEventListener('click', resetToWelcomeScreen);
            
            floatingComparisonBtn.addEventListener('click', () => {
                analysisContainer.classList.add('hidden');
                competitorComparisonContainer.classList.remove('hidden');
                findAndRenderCompetitors(currentPlaceDetails);
                floatingComparisonBtn.classList.add('hidden');
                floatingBackBtn.classList.remove('hidden');
                floatingSolutionBtn.classList.remove('hidden');
                hideWarningBar();
            });
            
            floatingBackBtn.addEventListener('click', () => {
                competitorComparisonContainer.classList.add('hidden');
                analysisContainer.classList.remove('hidden');
                floatingComparisonBtn.classList.remove('hidden');
                floatingBackBtn.classList.add('hidden');
                floatingSolutionBtn.classList.add('hidden');
                updateVerificationStatus();
            });
            
            floatingSolutionBtn.addEventListener('click', () => {
                competitorComparisonContainer.classList.add('hidden');
                solutionProposalContainer.classList.remove('hidden');
                
                floatingBackBtn.classList.add('hidden');
                floatingSolutionBtn.classList.add('hidden');
                floatingBackToComparisonBtn.classList.remove('hidden');

                renderSolutionProposal();
                hideWarningBar();
            });

            floatingBackToComparisonBtn.addEventListener('click', () => {
                solutionProposalContainer.classList.add('hidden');
                competitorComparisonContainer.classList.remove('hidden');

                floatingBackToComparisonBtn.classList.add('hidden');
                floatingBackBtn.classList.remove('hidden');
                floatingSolutionBtn.classList.remove('hidden');
            });

            const floatingWarningBar = $('#floating-warning-bar');
            const warningCloseBtn = floatingWarningBar.querySelector('.close-btn');
            warningCloseBtn.addEventListener('click', () => {
                floatingWarningBar.classList.add('hidden');
                floatingWarningBar.classList.remove('visible');
                floatingNewAnalysisBtn.style.bottom = '30px';   
                floatingComparisonBtn.style.bottom = '95px';
            });

            // --- HLAVN√Å FUNKCIA ---
            const startAnalysisFlow = (placeId) => {
                if (!placeId) return;
                
                welcomeScreen.style.opacity = 0;
                setTimeout(() => {
                    welcomeScreen.classList.add('hidden');
                }, 500);

                document.body.style.overflow = 'auto';

                analysisContainer.innerHTML = '<div class="spinner"><i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary-color)"></i></div>';
                analysisContainer.classList.remove('hidden');
                competitorComparisonContainer.classList.add('hidden');
                solutionProposalContainer.classList.add('hidden');
                floatingNewAnalysisBtn.classList.remove('hidden');
                floatingComparisonBtn.classList.remove('hidden');
                
                placesService.getDetails({ placeId, fields: placeDetailsFields }, (details, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && details) {
                        currentPlaceDetails = details;
                        
                        analysisContainer.innerHTML = `
                            <div id="top-overview-panel" class="analysis-top-panel"></div>
                            <div class="analysis-layout">
                                <div id="auto-details-widget" class="analysis-widget"></div>
                                <div id="manual-analysis-widget" class="analysis-widget"></div>
                                <div id="score-widget" class="analysis-widget"></div>
                            </div>
                        `;
                        
                        renderTopPanel(details);
                        renderAutoDetailsWidget(details);
                        renderManualAnalysisWidget(details);
                        
                        updateVerificationStatus();
                        updateManualChecklistState();
                        recalculateAndRenderScore();

                        const claimedCheckbox = $('#check-claimed');
                        if (claimedCheckbox) {
                            claimedCheckbox.addEventListener('change', () => {
                                updateVerificationStatus();
                                updateManualChecklistState();
                                recalculateAndRenderScore();
                            });
                        }

                    } else {
                        showError('Nepodarilo sa naƒç√≠ta≈• detaily firmy.');
                    }
                });
            };
            
            const showError = (message) => {
                analysisContainer.classList.add('hidden');
                competitorComparisonContainer.classList.add('hidden');
                welcomeScreen.classList.remove('hidden');
                welcomeScreen.style.opacity = 1;
                floatingNewAnalysisBtn.classList.add('hidden');   
                floatingComparisonBtn.classList.add('hidden');
            };

            function initializeGoogleAndAutocomplete() {
                if (!window.google || !window.google.maps || !window.google.maps.places) {
                    setTimeout(initializeGoogleAndAutocomplete, 100); return;
                }
                placesService = new google.maps.places.PlacesService($('#map-service-container'));
                streetViewService = new google.maps.StreetViewService();
                const autocomplete = new google.maps.places.Autocomplete(gmfInput, { types: ['establishment'], fields: ['place_id', 'name', 'formatted_address'] });
                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (place && place.place_id) startAnalysisFlow(place.place_id);
                });
            }
            
            const script = document.getElementById('google-maps-script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=places,geometry&language=sk&callback=initGoogleServices`;
            window.initGoogleServices = initializeGoogleAndAutocomplete;
            
            // --- Vykresƒæovacie funkcie ---
            const renderTopPanel = (d) => {
                const photoUrl = d.photos && d.photos.length > 0
                    ? d.photos[0].getUrl({ maxWidth: 1024, maxHeight: 250 })
                    : 'https://placehold.co/1024x250/EAEAEA/B6B6B6?text=Fotografia+nie+je+dostupn%C3%A1';

                const placeName = encodeURIComponent(d.name);
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${placeName}&query_place_id=${d.place_id}`;
                const searchUrl = `https://www.google.com/search?q=${placeName}`;
                
                let businessStatusText = 'Neakt√≠vne';
                let statusColor = 'var(--google-red)';
                let statusIcon = 'fa-eye-slash';

                if (d.business_status === 'OPERATIONAL') {
                    businessStatusText = 'Viditeƒæn√©';
                    statusColor = 'var(--google-green)';
                    statusIcon = 'fa-eye';
                } else if (d.business_status === 'CLOSED_TEMPORARILY') {
                    businessStatusText = 'Pozastaven√©';
                    statusColor = 'var(--google-yellow)';
                    statusIcon = 'fa-pause-circle';
                }

                $('#top-overview-panel').innerHTML = `
                    <div class="top-panel-background" style="background-image: url('${photoUrl}');"></div>
                    <div class="top-panel-content">
                        <div class="top-panel-header">
                            <div class="company-info">
                                <div class="company-details-group">
                                    <span id="verification-icon-container" class="fa-stack verified-icon">
                                        <i class="fas fa-shield-alt fa-stack-2x" id="shield-icon"></i>
                                        <i class="fas fa-times fa-stack-1x" id="status-icon" style="color:white;"></i>
                                    </span>
                                    <div id="company-details-box">
                                        <h2>${d.name || 'Nezn√°my podnik'}</h2>
                                        <div class="rating-info">
                                            <i class="fas fa-star"></i>
                                            <span>${d.rating?.toFixed(1) || 'N/A'}</span>
                                            <span style="margin-left:5px;">(${d.user_ratings_total || 0} recenzi√≠)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="company-actions-block">
                                <div class="status-button" style="background-color: ${statusColor};">
                                    <i class="fas ${statusIcon}"></i>
                                    <span>${businessStatusText}</span>
                                </div>
                                <div class="company-actions">
                                    <a id="open-search-btn" class="btn" target="_blank" href="${searchUrl}"><i class="fas fa-search"></i> Google</a>
                                    <a id="open-maps-btn" class="btn" target="_blank" href="${mapsUrl}"><i class="fas fa-map-marker-alt"></i> Mapy</a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            };

            const renderAutoDetailsWidget = (d) => {
                const getData = (value, formatter) => {
                    const fallback = '<span class="missing">Ch√Ωba</span>';
                    if (value === null || typeof value === 'undefined' || value === '' || (Array.isArray(value) && value.length === 0)) return fallback;
                    if (typeof formatter === 'function') {
                        const result = formatter(value);
                        return result === null || result === '' ? fallback : result;
                    }
                    if (typeof value === 'boolean') return value ? '<span class="present">√Åno</span>' : '<span class="missing">Nie</span>';
                    return value;
                };

                const formatPhotoCount = (photos) => {
                    if (!photos || photos.length === 0) {
                        return '<span class="missing">Ch√Ωba</span>';
                    }
                    const count = photos.length;
                    return count >= 10 ? '10+' : count;
                };

                const formatPriceLevel = (level) => {
                    switch (level) {
                        case 0: return 'Zadarmo';
                        case 1: return 'N√≠zka';
                        case 2: return 'Stredn√°';
                        case 3: return 'Vysok√°';
                        case 4: return 'Veƒæmi vysok√°';
                        default: return null;
                    }
                };

                const openingHoursHtml = d.opening_hours?.weekday_text?.map(day => {
                    const parts = day.split(':');
                    const dayName = parts[0].trim();
                    const hours = parts.slice(1).join(':').trim();
                    return `<span>${dayName}:</span><span>${hours}</span>`;
                }).join('') || '<span class="missing">Ch√Ωba</span>';

                const hasReviews = d.reviews && d.reviews.length > 0;
                const hasGeometry = d.geometry && d.geometry.location;

                const hasStreetView = d.geometry && d.geometry.location;

                if (hasStreetView) {
                    streetViewService.getPanorama({
                        location: d.geometry.location,
                        radius: 50,
                        source: google.maps.StreetViewSource.OUTDOOR
                    }, (data, status) => {
                        const streetViewToggleBtn = $('#street-view-toggle-btn');
                        if (!streetViewToggleBtn) return;
                        if (status === google.maps.StreetViewStatus.OK) {
                            streetViewToggleBtn.innerHTML = `<span>Zobrazi≈• Street View</span><i class="fas fa-chevron-down"></i>`;
                            streetViewToggleBtn.disabled = false;
                        } else {
                            streetViewToggleBtn.innerHTML = `<span>Street View ch√Ωba</span><i class="fas fa-chevron-down"></i>`;
                            streetViewToggleBtn.disabled = true;
                        }
                    });
                }

                $('#auto-details-widget').innerHTML = `
                    <h3><i class="fas fa-cogs"></i> F√°za 1: Automatick√° anal√Ωza</h3>
                    <ul class="details-list">
                        <h4>Kateg√≥rie</h4>
                        <li><strong>Prim√°rna kateg√≥ria:</strong> <div class="value-col">${getData(d.types?.[0])?.replace(/_/g, ' ')}</div></li>
                        <li><strong>Sekund√°rne kateg√≥rie:</strong> <div class="value-col">${getData(d.types?.slice(1), arr => arr.map(i => i.replace(/_/g, ' ')).join(', '))}</div></li>
                        <h4>Kontaktn√© inform√°cie</h4>
                        <li><strong>Adresa:</strong> <div class="value-col">${getData(d.formatted_address)}</div></li>
                        <li><strong>Web:</strong> <div class="value-col">${getData(d.website, url => `<a href="${url}" target="_blank">${url}</a>`)}</div></li>
                        <li><strong>Telef√≥n:</strong> <div class="value-col">${getData(d.formatted_phone_number)}</div></li>
                        <li><strong>Plus Code:</strong> <div class="value-col">${getData(d.plus_code?.global_code)}</div></li>
                        <li>
                            <strong>Otv√°racie hodiny:</strong>
                            <div class="value-col">
                                <button type="button" class="toggle-btn" id="opening-hours-toggle">
                                    <span>${d.opening_hours?.weekday_text ? 'Zobrazi≈• dni' : 'Ch√Ωba'}</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </li>
                        <li class="opening-hours-detail hidden">
                            <div class="opening-hours-grid">${openingHoursHtml}</div>
                        </li>
                        <li>
                            <strong>GPS poloha:</strong>
                            <div class="value-col">
                                <button type="button" class="toggle-btn" id="map-toggle-btn">
                                    <span>${hasGeometry ? 'Zobrazi≈• mapu' : 'Ch√Ωba'}</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </li>
                        <li class="map-detail hidden">
                            <div id="map" class="map-container"></div>
                        </li>
                        <li>
                            <strong>Street View:</strong>
                            <div class="value-col">
                                <button type="button" class="toggle-btn" id="street-view-toggle-btn">
                                    <span>Naƒç√≠tavam...</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </li>
                        <li class="street-view-detail hidden">
                            <div id="street-view-panorama" class="street-view-container"></div>
                        </li>
                        <h4>Hodnotenie</h4>
                        <li><strong>Priem. hodnotenie:</strong> <div class="value-col">${getData(d.rating, r => `<strong>${r} ‚òÖ</strong>`)}</div></li>
                        <li><strong>Poƒçet hodnoten√≠:</strong> <div class="value-col">${getData(d.user_ratings_total)}</div></li>
                        <li>
                            <strong>Najnov≈°ie recenzie:</strong>
                            <div class="value-col">
                                <button type="button" class="toggle-btn" id="reviews-toggle-btn">
                                    <span>Najnov≈°ie</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </li>
                        <li class="reviews-list-container">
                            <div class="value-col" id="reviews-list"></div>
                        </li>
                        <h4>Obsah</h4>
                        <li><strong>Poƒçet fotografi√≠:</strong> <div class="value-col">${formatPhotoCount(d.photos)}</div></li>
                        <li><strong>Popis od vlastn√≠ka:</strong> <div class="value-col">${getData(d.editorial_summary?.overview)}</div></li>
                        <h4>Ostatn√©</h4>
                        <li><strong>Cenov√° √∫rove≈à:</strong> <div class="value-col">${getData(d.price_level, formatPriceLevel)}</div></li>
                        <li><strong>Bezbari√©rov√Ω vchod:</strong> <div class="value-col">${getData(d.wheelchair_accessible_entrance)}</div></li>
                    </ul>`;

                const openingHoursToggleBtn = $('#opening-hours-toggle');
                const openingHoursLi = $('#auto-details-widget .opening-hours-detail');
                const reviewsToggleBtn = $('#reviews-toggle-btn');
                const reviewsListContainer = $('.reviews-list-container');
                const reviewsList = $('#reviews-list');
                const reviews = d.reviews;
                const streetViewToggleBtn = $('#street-view-toggle-btn');
                const streetViewLi = $('.street-view-detail');
                let map;
                let panorama;

                if (streetViewToggleBtn && streetViewLi && hasGeometry) {
                    streetViewToggleBtn.addEventListener('click', () => {
                        streetViewLi.classList.toggle('hidden');
                        streetViewToggleBtn.classList.toggle('expanded');
                        const span = streetViewToggleBtn.querySelector('span');

                        if (!streetViewLi.classList.contains('hidden')) {
                            span.textContent = 'Skry≈• Street View';
                            if (!panorama) {
                                panorama = new google.maps.StreetViewPanorama(
                                    document.getElementById('street-view-panorama'), {
                                        position: d.geometry.location,
                                        pov: { heading: 165, pitch: 0 },
                                        linksControl: true,
                                        panControl: true,
                                        zoomControl: true,
                                        enableCloseButton: false,
                                    });
                                panorama.setOptions({
                                    addressControl: false
                                });
                            }
                        } else {
                            span.textContent = 'Zobrazi≈• Street View';
                        }
                    });
                } else if (streetViewToggleBtn) {
                    streetViewToggleBtn.innerHTML = `<span>Street View ch√Ωba</span><i class="fas fa-chevron-down"></i>`;
                    streetViewToggleBtn.disabled = true;
                }

                if (!reviews || reviews.length === 0) {
                    reviewsToggleBtn.innerHTML = '<span class="missing">≈Ωiadne recenzie</span>';
                    reviewsToggleBtn.disabled = true;
                } else {
                    reviewsToggleBtn.addEventListener('click', () => {
                        reviewsListContainer.classList.toggle('show');
                        reviewsToggleBtn.classList.toggle('expanded');
                        
                        if (reviewsListContainer.classList.contains('show')) {
                            reviewsToggleBtn.querySelector('span').textContent = 'Skry≈• recenzie';
                            const sortedReviews = reviews.sort((a, b) => b.time - a.time).filter(r => r.text && r.text.trim() !== '').slice(0, 3);
                            let reviewsHtml = '';
                            sortedReviews.forEach(review => {
                                const date = new Date(review.time * 1000).toLocaleDateString('sk-SK');
                                const stars = '‚òÖ'.repeat(Math.round(review.rating));
                                reviewsHtml += `
                                    <div class="review-card">
                                        <div class="review-header">
                                            <span class="review-author">${review.author_name}</span>
                                            <div class="review-rating">${stars}</div>
                                        </div>
                                        <div class="review-text">${review.text}</div>
                                        <div class="review-time">(${date})</div>
                                    </div>
                                `;
                            });
                            reviewsList.innerHTML = reviewsHtml;
                        } else {
                            reviewsToggleBtn.querySelector('span').textContent = 'Najnov≈°ie';
                        }
                    });
                }

                if (openingHoursToggleBtn && openingHoursLi) {
                    openingHoursToggleBtn.addEventListener('click', () => {
                        openingHoursLi.classList.toggle('hidden');
                        openingHoursToggleBtn.classList.toggle('expanded');
                        const span = openingHoursToggleBtn.querySelector('span');
                        if (openingHoursLi.classList.contains('hidden')) {
                            span.textContent = 'Zobrazi≈• dni';
                        } else {
                            span.textContent = 'Skry≈• dni';
                        }
                    });
                }

                const mapToggleBtn = $('#map-toggle-btn');
                const mapLi = $('.map-detail');
                
                if (hasGeometry) {
                    mapToggleBtn.addEventListener('click', () => {
                        mapLi.classList.toggle('hidden');
                        mapToggleBtn.classList.toggle('expanded');
                        const span = mapToggleBtn.querySelector('span');
                        if (mapLi.classList.contains('hidden')) {
                            span.textContent = 'Zobrazi≈• mapu';
                        } else {
                            span.textContent = 'Skry≈• mapu';
                            if (!map) {
                                const mapElement = $('#map');
                                map = new google.maps.Map(mapElement, {
                                    center: d.geometry.location,
                                    zoom: 15
                                });
                                new google.maps.Marker({
                                    position: d.geometry.location,
                                    map: map,
                                    title: d.name
                                });
                            }
                            google.maps.event.trigger(map, 'resize');
                        }
                    });
                } else if (mapToggleBtn) {
                    mapToggleBtn.disabled = true;
                }
            };

            const updateManualChecklistState = () => {
                const checklist = $('#manual-checklist');
                if (!checklist) return;
                const checkboxes = checklist.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    manualChecklistState[cb.id] = cb.checked;
                });
                const reviewReplyBtn = $('#review-reply-btn');
                if (reviewReplyBtn) {
                    manualChecklistState['review-reply-btn'] = reviewReplyBtn.dataset.value;
                }
            };

            // renderManualAnalysisWidget, recalculateAndRenderScore, updateVerificationStatus, findAndRenderCompetitors, renderSolutionProposal
            // predpoklad√°me bez zmeny logiky, iba texty vy≈°≈°ie s√∫ lokalizovan√©
        });
    </script>
</body>
</html>
