<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMF Analýza | Nájdite svoj potenciál</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400&display=swap');
        
        :root {
            --google-blue: #4285F4;
            --google-red: #EA4335;
            --google-green: #34A853;
            --google-yellow: #FBBC04;
            --text-dark: #202124;
            --text-light: #5f6368;
            --border-color: #dfe1e5;
            --background-light: #f8f9fa;
            --background-color: #f0f2f5;
            --primary-color: var(--google-green);
            --secondary-color: var(--google-blue);
            --card-bg-color: #ffffff;
            --star-color: var(--google-yellow);
            --danger-color: var(--google-red);
            --score-red: var(--google-red);
            --score-orange: var(--google-yellow);
            --score-green: var(--google-green);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Roboto', sans-serif;
            color: var(--text-dark);
            background-color: var(--background-light);
            overflow: hidden; /* Zabrání scrollbarům z plátna */
        }
        
        /* --- STYLY PRO ÚVODNÍ OBRAZOVKU --- */
        #welcome-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100%;
            overflow: hidden;
            position: relative;
            transition: opacity 0.5s ease-out;
        }

        #particle-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .welcome-header {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            width: 100%;
            padding: 30px 40px;
        }

        .welcome-logo {
            width: 120px;
            height: auto;
        }
        
        .welcome-content {
            position: relative;
            z-index: 5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 50px;
            
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            max-width: 850px;
            width: 90%;
        }
        .welcome-content h1 {
            font-family: 'Google Sans', sans-serif;
            font-size: 3.2rem;
            font-weight: 700;
            margin-bottom: 16px;
            max-width: 750px;
            color: var(--text-dark);
            line-height: 1.2;
        }
        
        .welcome-content .subtitle {
            font-size: 1.25rem;
            color: var(--text-light);
            margin-bottom: 40px;
            max-width: 650px;
            line-height: 1.7;
        }
        
        .search-container { 
            display: flex; 
            align-items: center; 
            background: #fff; 
            border: 1px solid var(--border-color); 
            border-radius: 30px; 
            width: 100%; 
            max-width: 600px; 
            padding: 12px 24px; 
            box-shadow: 0 1px 6px rgba(32,33,36,.28); 
            transition: box-shadow 0.2s; 
        }
        .search-container:hover, .search-container:focus-within { 
            box-shadow: 0 4px 12px rgba(32,33,36,.2);
        }
        .search-container i { 
            font-size: 1.2rem; 
            color: var(--text-light); 
            margin-right: 12px; 
        }
        .search-container input { 
            width:100%; 
            flex-grow: 1; 
            border: none; 
            outline: none; 
            font-size: 1.1rem; 
            font-family: 'Roboto', sans-serif; 
            background: transparent; 
        }

        @media (max-width: 768px) {
            .welcome-content h1 {
                font-size: 2.5rem;
            }
            .welcome-content .subtitle {
                font-size: 1.1rem;
            }
            .welcome-content {
                padding: 40px 25px;
            }
        }
        
        /* --- STYLY PRO SEKCI S VÝSLEDKY ANALÝZY --- */
        .app-container { max-width: 1200px; margin: 20px auto; padding:20px; }
        .hidden { display: none !important; }
        .spinner { text-align: center; padding: 40px; }
        
        .analysis-layout { display: grid; grid-template-columns: minmax(350px, 1.5fr) 1fr 0.8fr; gap: 25px; align-items: flex-start; }
        @media (max-width: 900px) { .analysis-layout { grid-template-columns: 1fr; } }
        
        .analysis-top-panel { background: var(--card-bg-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 25px; overflow: hidden; padding: 0; position: relative; min-height: 250px; }
        .top-panel-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; filter: brightness(0.6) blur(1.5px); }
        .top-panel-content { position: absolute; top: 0; left: 0; z-index: 3; color: white; height: 100%; width: 100%; padding: 25px; display: flex; flex-direction: column; justify-content: space-between; }
        .top-panel-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px; }
        .company-info { display: flex; flex-direction: column; gap: 15px; align-items: flex-start; }
        .company-details-group { display: flex; align-items: center; gap: 15px; }
        .company-name-section h2 { font-size: 2.2em; margin: 0; line-height: 1.2; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .status-button { display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 20px; font-size: 0.9em; font-weight: 500; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.4); box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background-color: 0.3s; }
        .verified-icon { position: relative; font-size: 2.5em; transition: color 0.4s; margin-right: -5px; }
        .verified-icon .fa-stack-1x { font-size: 0.5em; color: white; }
        .company-actions-block { display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        .company-actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 0; justify-content: flex-end; }
        .btn { padding: 10px 18px; font-size: 0.9em; border-radius: 8px; background-color: var(--google-blue); color: white; text-decoration: none; display: inline-flex; align-items: center; border: none; cursor: pointer; gap: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s; }
        .btn:hover { background-color: #3367D6; box-shadow: 0 6px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .btn-green { background-color: var(--google-green); }
        .btn-green:hover { background-color: #2e8b57; }
        .btn-sm { padding: 5px 10px; font-size: 0.8em; }
        .analysis-widget { background: var(--card-bg-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 25px; }
        .analysis-widget h3 { font-size: 1.2em; border-bottom: 1px solid #f0f0f0; margin: -25px -25px 20px -25px; padding: 15px 25px; }
        .analysis-widget h3 i { margin-right: 10px; color: var(--primary-color); }
        .details-list { list-style: none; }
        .details-list li { padding: 12px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; }
        .details-list li:last-child { border-bottom: none; }
        .details-list li > strong { font-weight: 500; flex-shrink: 0; color: var(--text-dark); }
        .details-list .value-col { text-align: right; color: var(--text-light); word-break: break-word; }
        .details-list .missing { color: var(--danger-color); font-style: italic; }
        .details-list .present { color: var(--google-green); }
        .details-list h4 { margin-top: 15px; color: var(--primary-color); text-align: left; width: 100%; border-top: 1px solid #e0e0e0; padding-top: 15px; }
        .details-list .toggle-btn { background: none; border: none; color: var(--secondary-color); cursor: pointer; font-size: 1rem; display: flex; align-items: center; gap: 5px; transition: color 0.2s, transform 0.2s; }
        .details-list .toggle-btn:hover { text-decoration: underline; }
        .details-list .toggle-btn .fas { transition: transform 0.2s; }
        .details-list .toggle-btn.expanded .fas { transform: rotate(180deg); }
        #manual-analysis-widget .manual-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .checklist-group { margin-bottom: 20px; }
        .checklist-group h4 { color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 10px; display: flex; align-items: center; font-size: 1.05em; }
        .checklist-group h4 i { margin-right: 10px; }
        .check-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0; font-size: 0.9em; }
        .check-item label { flex-grow: 1; user-select: none; line-height: 1.4; white-space: normal; text-align: left; max-width: calc(100% - 40px); }
        .check-item input[type="checkbox"] { width: 1.5em; height: 1.5em; cursor: pointer; flex-shrink: 0; }
        #score-widget { text-align: center; position: sticky; top: 20px; z-index: 10; }
        #score-widget .score-circle-wrapper { display: flex; flex-direction: column; align-items: center; }
        #score-widget .score-circle { position: relative; width: 180px; height: 180px; border-radius: 50%; background: conic-gradient(var(--score-green) 0deg, #e9ecef 0deg); display: flex; justify-content: center; align-items: center; margin: 0 auto 20px auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: background 1s ease-out; }
        #score-widget .score-circle::before { content: ''; position: absolute; width: 150px; height: 150px; background: #fff; border-radius: 50%; }
        #score-widget .score-value { position: relative; font-size: 3em; font-weight: 700; color: var(--score-green); }
        .score-breakdown-toggle { cursor: pointer; font-weight: 500; color: var(--secondary-color); margin-top: 15px; display: inline-flex; align-items: center; user-select: none; transition: color 0.2s; }
        .score-breakdown-toggle:hover { color: var(--google-blue); }
        .score-breakdown-toggle i { margin-left: 8px; transition: transform 0.2s; }
        .score-breakdown-toggle.expanded i { transform: rotate(180deg); }
        .score-breakdown-list { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; padding-top: 0; }
        .score-breakdown-list.show { max-height: 1000px; padding-top: 15px; }
        .score-breakdown-list ul { padding: 0; margin: 0; list-style: none; }
        .score-breakdown-list li { display: flex; align-items: center; justify-content: flex-start; padding: 4px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; }
        .score-breakdown-list li i { width: 20px; flex-shrink: 0; margin-right: 10px; }
        .score-breakdown-list li span { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; }
        .score-breakdown-list .earned { color: var(--google-green); }
        .score-breakdown-list .missed { color: var(--danger-color); }
        .rating-info { display: flex; align-items: center; color: white; font-size: 1.1em; text-shadow: 1px 1px 2px rgba(0,0,0,0.4); }
        .rating-info i { margin-right: 5px; color: var(--star-color); letter-spacing: 2px; font-size: 1.2em; }
        .pac-container { z-index: 1050 !important; }
        @media (max-width: 900px) { .top-panel-header-content { max-width: 100%; } }
        #floating-warning-bar { position: fixed; bottom: 20px; right: 20px; width: 280px; height: 280px; background-color: var(--danger-color); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100; display: flex; flex-direction: column; justify-content: space-between; opacity: 0; visibility: hidden; transition: opacity 0.5s ease-out, visibility 0.5s ease-out; text-align: left; }
        #floating-warning-bar ul { list-style: none; padding: 0; margin-top: 15px; }
        #floating-warning-bar li { margin-bottom: 8px; font-size: 0.9em; line-height: 1.4; }
        #floating-warning-bar.visible { opacity: 1; visibility: visible; }
        #floating-warning-bar .close-btn { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; margin-left: auto; opacity: 0.8; transition: opacity 0.2s; }
        #floating-warning-bar .close-btn:hover { opacity: 1; }
        #floating-warning-bar h4 { margin: 0; font-size: 1.1em; display: flex; align-items: center; gap: 10px; }
        #floating-warning-bar p { font-size: 0.9em; margin: 0; opacity: 0.8; line-height: 1.4; }
        #company-details-box { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); padding: 15px 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .top-panel-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px; }
        .company-info { display: flex; flex-direction: column; gap: 15px; align-items: flex-start; }
        .company-details-group { display: flex; align-items: center; gap: 15px; }
        .company-actions-block { display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        .company-actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 0; justify-content: flex-end; }
        .review-card { background: #f9f9f9; border-radius: 8px; padding: 15px; margin-bottom: 10px; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
        .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .review-author { font-weight: 500; color: var(--text-dark); }
        .review-rating { color: var(--star-color); letter-spacing: 2px; font-size: 1.2em; }
        .review-time { font-size: 0.8em; color: var(--text-light); margin-top: 5px; }
        .review-text { font-size: 0.9em; line-height: 1.4; color: var(--text-light); margin-bottom: 10px; }
        .reviews-list-container { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out, padding 0.5s ease-out; }
        .reviews-list-container.show { max-height: 2000px; padding-top: 15px; }
        .opening-hours-grid { display: grid; grid-template-columns: minmax(100px, max-content) 1fr; gap: 5px 20px; width: 100%; }
        .map-container, .street-view-container { height: 300px; width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .review-dropdown-wrapper { position: relative; display: inline-flex; align-items: center; min-width: 100px; }
        .review-select-btn { background: none; border: none; padding: 0; font-size: 1rem; cursor: pointer; outline: none; transition: color 0.2s; display: flex; align-items: center; gap: 5px; color: var(--secondary-color); flex-grow: 1; justify-content: flex-end; text-align: right; }
        .review-select-btn:hover { color: var(--google-blue); }
        .review-select-btn .fa-chevron-down { transition: transform 0.2s; }
        .review-select-btn.expanded .fa-chevron-down { transform: rotate(180deg); }
        .review-select-options { position: absolute; top: 100%; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 10; margin-top: 5px; width: 100%; min-width: 150px; list-style: none; padding: 5px 0; display: none; }
        .review-select-options.show { display: block; }
        .review-select-options li { padding: 8px 12px; cursor: pointer; text-align: left; transition: background-color 0.2s; }
        .review-select-options li:hover { background-color: #f0f0f0; }
        .check-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
        .check-item label { flex-grow: 1; user-select: none; }
        
        /* STYLY PRO POROVNÁNÍ KONKURENCE */
        .comparison-header { width: 100%; background: var(--card-bg-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 25px; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 15px; position: relative; }
        .comparison-header h3 { font-size: 1.5em; margin: 0; color: var(--text-dark); text-align: center; }
        .comparison-header h3 i { margin-right: 10px; color: var(--primary-color); }
        .competitor-add-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; align-items: center; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .competitor-add-container .search-container { flex-grow: 1; margin: 0; max-width: none; }
        .comparison-cards-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; width: 100%; margin-top: 25px; }
        .competitor-card { background-color: var(--card-bg-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 20px; text-align: center; position: relative; display: flex; flex-direction: column; }
        .competitor-card.main-company { border: 2px solid var(--primary-color); box-shadow: 0 0 15px rgba(52, 168, 83, 0.4); }
        .competitor-card .card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 5px; }
        .competitor-card .card-top-actions { position: static; display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
        .competitor-card .card-action-btn { background-color: rgba(255, 255, 255, 0.7); color: var(--text-light); border-radius: 50%; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; transition: all 0.2s; font-size: 0.9em; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .competitor-card .card-action-btn:hover { background-color: #fff; color: var(--text-dark); transform: scale(1.1); }
        .competitor-card h4 { font-size: 1.2em; font-weight: 500; margin-bottom: 0; text-align: left; flex-grow: 1; }
        .competitor-card .rating-info { color: var(--text-dark); justify-content: center; margin-bottom: 15px; display: flex; align-items: center; flex-wrap: wrap; gap: 5px 15px;}
        .competitor-card .rating-info i { font-size: 1em; margin-right: 5px; color: var(--star-color); }
        .competitor-card .rating-info span { font-weight: bold; }
        .competitor-card .metrics-list { list-style: none; padding: 0; text-align: left; flex-grow: 1; border-top: 1px solid #f0f0f0; margin-top: 10px; padding-top: 15px; }
        .competitor-card .metrics-list li { display: flex; align-items: center; justify-content: space-between; padding: 5px 0; font-size: 0.9em; }
        .competitor-card .remove-btn { position: static; padding: 0; border: none; width: 32px; height: 32px; line-height: 1; border-radius: 50%; background-color: rgba(255, 255, 255, 0.7); color: var(--text-light); cursor: pointer; font-size: 1.2em; transition: all 0.2s; }
        .competitor-card .remove-btn:hover { background-color: var(--danger-color); color: white; transform: scale(1.1); }
        .chart-section { background: var(--card-bg-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 25px; margin-top: 25px; }
        .chart-section h3 { margin-bottom: 25px; color: var(--text-dark); }
        .chart-section h3 i { color: var(--primary-color); margin-right: 10px; }
        .chart-bar-container { display: flex; align-items: center; margin-bottom: 15px; gap: 15px; }
        .chart-label { width: 200px; flex-shrink: 0; font-weight: 500; color: var(--text-dark); text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
        .chart-bar-wrapper { flex-grow: 1; height: 30px; background-color: #f0f0f0; border-radius: 8px; overflow: hidden; position: relative; }
        .chart-bar { height: 100%; transition: width 0.5s ease-out, background-color 0.3s; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: white; overflow: hidden; }
        .chart-score { font-weight: bold; font-size: 1em; text-shadow: 1px 1px 2px rgba(0,0,0,0.4); white-space: nowrap; }
        .competitor-card .checklist-group { margin-top: 15px; border-top: 1px solid #f0f0f0; padding-top: 15px; }
        .competitor-card .checklist-group h4 { font-size: 0.9em; margin-bottom: 10px; color: var(--primary-color); text-align: left; }
        .competitor-card .check-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 0.85em; text-align: left; }
        .competitor-card .check-item label { flex-grow: 1; user-select: none; }
        .podium-chart-container { display: flex; justify-content: center; align-items: flex-end; gap: 5px; height: 300px; padding: 20px; border-bottom: 5px solid #e0e0e0; box-sizing: content-box; }
        .podium-step { width: 33%; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 20px 10px; border-radius: 10px 10px 0 0; color: white; text-align: center; box-shadow: inset 0 6px 10px rgba(0,0,0,0.2); transition: height 0.5s ease-out, background-color 0.5s ease-out; }
        .podium-step h4 { font-size: 1em; font-weight: bold; margin: 0 0 10px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.4); word-break: break-word; }
        .podium-info { font-size: 1.2em; font-weight: bold; }
        .podium-info .review-count { font-size: 0.8em; font-weight: normal; opacity: 0.9; display: block; }
        .podium-medal { font-size: 2.5em; margin-bottom: 10px; }
        .podium-1 { height: 100%; order: 2; }
        .podium-1 .podium-medal { text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .podium-2 { height: 85%; order: 1; }
        .podium-3 { height: 70%; order: 3; }
        
        /* --- STYLY PRO PLOVOUCÍ TLAČÍTKA --- */
        #floating-new-analysis-btn { position: fixed; right: 30px; bottom: 30px; z-index: 1001; background-color: var(--google-blue); color: white; border: none; border-radius: 50px; padding: 15px 25px; font-size: 1rem; font-weight: 500; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; transition: transform 0.2s ease-out, background-color 0.2s, bottom 0.5s ease-out; }
        #floating-new-analysis-btn:hover { transform: scale(1.05); background-color: #3367D6; }
        #floating-comparison-btn { position: fixed; right: 30px; bottom: 95px; z-index: 1001; background-color: var(--google-green); color: white; border: none; border-radius: 50px; padding: 15px 25px; font-size: 1rem; font-weight: 500; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; transition: transform 0.2s ease-out, background-color 0.2s, bottom 0.5s ease-out; }
        #floating-comparison-btn:hover { transform: scale(1.05); background-color: #2e8b57; }
        #floating-back-btn { position: fixed; left: 30px; bottom: 30px; z-index: 1001; border-radius: 50px; padding: 15px 25px; }
        #floating-solution-btn { position: fixed; right: 30px; bottom: 95px; z-index: 1001; border-radius: 50px; padding: 15px 25px; }
        #floating-back-to-comparison-btn { position: fixed; left: 30px; bottom: 30px; z-index: 1001; border-radius: 50px; padding: 15px 25px; background-color: var(--text-light); }
        #floating-back-to-comparison-btn:hover { background-color: #70757a; }

        /* --- NOVÉ STYLY PRO NÁVRH ŘEŠENÍ --- */
        #solution-proposal-container .solution-header { text-align: center; margin-bottom: 30px; }
        #solution-proposal-container .solution-header h2 { font-size: 2.2em; margin-bottom: 10px; }
        #solution-proposal-container .solution-header p { font-size: 1.1em; color: var(--text-light); }
        .solution-category { margin-bottom: 35px; }
        .solution-category h3 { font-size: 1.5em; color: var(--text-dark); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px;}
        .recommendation-card { background: var(--card-bg-color); border-left: 5px solid var(--google-blue); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 25px; margin-bottom: 20px; display: grid; grid-template-columns: 50px 1fr; gap: 0 25px; align-items: start; }
        .recommendation-card.critical { border-left-color: var(--danger-color); }
        .recommendation-icon { font-size: 2em; color: var(--google-blue); grid-row: 1 / span 2; display: flex; justify-content: center; align-items: flex-start; padding-top: 5px; }
        .recommendation-card.critical .recommendation-icon { color: var(--danger-color); }
        .recommendation-title { font-size: 1.2em; font-weight: 700; margin: 0 0 15px 0; }
        .recommendation-content h4 { font-size: 1em; font-weight: 500; color: var(--text-dark); margin-top: 0; margin-bottom: 8px; }
        .recommendation-content p { line-height: 1.6; color: var(--text-light); font-size: 0.95em; margin: 0; }
        .recommendation-content .why { margin-bottom: 15px; }
        .congrats-message { text-align: center; padding: 50px; background: var(--card-bg-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .congrats-message .fa-check-circle { font-size: 4em; color: var(--google-green); margin-bottom: 20px; }
        .congrats-message h2 { font-size: 2em; margin-bottom: 10px; }
        .congrats-message p { font-size: 1.1em; color: var(--text-light); }

    </style>
</head>
<body>
    
    <main id="welcome-screen">
        <canvas id="particle-canvas"></canvas>
        <header class="welcome-header">
             <img src="https://viewcz.com/images/svg/head-logo.svg" alt="ViewCZ Logo" class="welcome-logo">
        </header>
        <div class="welcome-content">
            <h1>Odhaľte plný potenciál svojho firemného profilu</h1>
            <p class="subtitle">V digitálnom svete je vaša vizitka na Google Mapách kľúčová. Náš nástroj vykoná hĺbkovú analýzu, porovná vás s konkurenciou a ukáže vám cestu k lepšej viditeľnosti a novým zákazníkom.</p>
            <div class="search-container">
                 <i class="fas fa-search"></i>
                 <input type="text" id="gmf-input" placeholder="Zadajte názov a adresu vašej firmy...">
            </div>
        </div>
    </main>
    
    <div class="app-container hidden" id="analysis-container"></div>
    <div class="app-container hidden" id="competitor-comparison-container"></div>
    <!-- NOVÝ KONTEJNER PRO NÁVRH ŘEŠENÍ -->
    <div class="app-container hidden" id="solution-proposal-container"></div>

    <div id="floating-warning-bar" class="hidden">
        <div>
            <h4><i class="fas fa-exclamation-triangle"></i> Kritický nedostatok</h4>
            <ul>
                <li>⚠️ Riziko prevzatia profilu</li>
                <li>🚫 Obmedzené možnosti správy</li>
                <li>📉 Horšie pozície vo vyhľadávaní a mapách</li>
                <li>❌ Nižšia dôveryhodnosť u zákazníkov</li>
                <li>📊 Obmedzený prístup k analytikám a funkciám</li>
            </ul>
        </div>
        <button class="close-btn">×</button>
    </div>
    
    <div id="map-service-container" style="display:none"></div>

    <!-- Plovoucí tlačítka -->
    <button id="floating-new-analysis-btn" class="btn hidden">
        <i class="fas fa-search-plus"></i> Nová analýza
    </button>
    <button id="floating-comparison-btn" class="btn btn-green hidden">
        <i class="fas fa-chart-bar"></i> Porovnanie s konkurenciou <i class="fas fa-arrow-right" style="margin-left: 8px;"></i>
    </button>
    <button id="floating-back-btn" class="btn hidden">
        <i class="fas fa-arrow-left"></i> Späť na analýzu
    </button>
    <button id="floating-solution-btn" class="btn btn-green hidden">
        <i class="fas fa-lightbulb"></i> Návrh riešenia <i class="fas fa-arrow-right" style="margin-left: 8px;"></i>
    </button>
    <!-- NOVÉ TLAČÍTKO ZPĚT -->
    <button id="floating-back-to-comparison-btn" class="btn hidden">
        <i class="fas fa-arrow-left"></i> Späť na porovnanie
    </button>


    <script> const API_KEY = "AIzaSyAnwJg7hLl05s-usDuSvrcM3nnu90dRczI"; </script>
    <script id="google-maps-script" async defer></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const $ = (s) => document.querySelector(s);
            const $$ = (s) => document.querySelectorAll(s);

            let placesService, currentPlaceDetails = null, competitors = [];
            let streetViewService = null;
            const gmfInput = $('#gmf-input');
            const welcomeScreen = $('#welcome-screen');
            const analysisContainer = $('#analysis-container');
            const competitorComparisonContainer = $('#competitor-comparison-container');
            const solutionProposalContainer = $('#solution-proposal-container'); // Nový kontejner
            
            const floatingNewAnalysisBtn = $('#floating-new-analysis-btn');   
            const floatingComparisonBtn = $('#floating-comparison-btn');
            const floatingBackBtn = $('#floating-back-btn');
            const floatingSolutionBtn = $('#floating-solution-btn');
            const floatingBackToComparisonBtn = $('#floating-back-to-comparison-btn'); // Nové tlačítko

            const placeDetailsFields = ['place_id', 'name', 'formatted_address', 'address_components', 'rating', 'user_ratings_total', 'types', 'url', 'geometry', 'opening_hours', 'website', 'formatted_phone_number', 'photos', 'reviews', 'business_status', 'editorial_summary', 'wheelchair_accessible_entrance', 'plus_code', 'price_level'];
            let manualChecklistState = {};
            let competitorsState = {};
            const MAX_COMPETITORS = 2;
            const RANK_COLORS = ['var(--google-green)', '#86B386', 'var(--google-yellow)', 'var(--google-red)'];
            
            // --- Particle Network Animation ---
            const canvas = document.getElementById('particle-canvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                let particlesArray;

                const mouse = { x: null, y: null, radius: (canvas.height/120) * (canvas.width/120) }

                window.addEventListener('mousemove', function(event){
                    mouse.x = event.x;
                    mouse.y = event.y;
                });

                class Particle {
                    constructor(x, y, directionX, directionY, size, color) {
                        this.x = x; this.y = y; this.directionX = directionX; this.directionY = directionY; this.size = size; this.color = color;
                    }
                    draw() {
                        ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false); ctx.fillStyle = this.color; ctx.fill();
                    }
                    update() {
                        if (this.x > canvas.width || this.x < 0) { this.directionX = -this.directionX; }
                        if (this.y > canvas.height || this.y < 0) { this.directionY = -this.directionY; }
                        let dx = mouse.x - this.x; let dy = mouse.y - this.y; let distance = Math.sqrt(dx*dx + dy*dy);
                        if (distance < mouse.radius + this.size){
                            if(mouse.x < this.x && this.x < canvas.width - this.size * 10){ this.x += 5; }
                            if(mouse.x > this.x && this.x > this.size * 10){ this.x -= 5; }
                            if(mouse.y < this.y && this.y < canvas.height - this.size * 10){ this.y += 5; }
                            if(mouse.y > this.y && this.y > this.size * 10){ this.y -= 5; }
                        }
                        this.x += this.directionX; this.y += this.directionY; this.draw();
                    }
                }

                function initParticles() {
                    particlesArray = [];
                    let numberOfParticles = (canvas.height * canvas.width) / 9000;
                    for (let i = 0; i < numberOfParticles; i++) {
                        let size = (Math.random() * 2) + 1;
                        let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2);
                        let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2);
                        let directionX = (Math.random() * 0.4) - 0.2;
                        let directionY = (Math.random() * 0.4) - 0.2;
                        let color = 'rgba(150, 150, 150, 0.4)';
                        particlesArray.push(new Particle(x, y, directionX, directionY, size, color));
                    }
                }

                function connect(){
                    let opacityValue = 1;
                    for(let a = 0; a < particlesArray.length; a++){
                        for (let b = a; b < particlesArray.length; b++){
                            let distance = ((particlesArray[a].x - particlesArray[b].x) * (particlesArray[a].x - particlesArray[b].x)) + ((particlesArray[a].y - particlesArray[b].y) * (particlesArray[a].y - particlesArray[b].y));
                            if (distance < (canvas.width/7) * (canvas.height/7)){
                                opacityValue = 1 - (distance/20000);
                                ctx.strokeStyle = `rgba(170, 170, 170, ${opacityValue})`;
                                ctx.lineWidth = 1;
                                ctx.beginPath(); ctx.moveTo(particlesArray[a].x, particlesArray[a].y); ctx.lineTo(particlesArray[b].x, particlesArray[b].y); ctx.stroke();
                            }
                        }
                    }
                }
                
                function animateParticles() {
                    requestAnimationFrame(animateParticles);
                    ctx.clearRect(0,0,innerWidth, innerHeight);
                    for (let i = 0; i < particlesArray.length; i++) { particlesArray[i].update(); }
                    connect();
                }

                window.addEventListener('resize', function(){
                    canvas.width = innerWidth; canvas.height = innerHeight;
                    mouse.radius = (canvas.height/120) * (canvas.width/120);
                    initParticles();
                });

                window.addEventListener('mouseout', function(){ mouse.x = undefined; mouse.y = undefined; });

                initParticles();
                animateParticles();
            }


            const hideWarningBar = () => {
                const floatingWarningBar = $('#floating-warning-bar');
                if (floatingWarningBar.classList.contains('visible')) {
                    floatingWarningBar.classList.remove('visible');
                    floatingNewAnalysisBtn.style.bottom = '30px';
                    floatingComparisonBtn.style.bottom = '95px';
                }
            }

            // --- FUNKCE PRO RESETOVÁNÍ APLIKACE DO VÝCHOZÍHO STAVU ---
            const resetToWelcomeScreen = () => {
                analysisContainer.classList.add('hidden');
                competitorComparisonContainer.classList.add('hidden');
                solutionProposalContainer.classList.add('hidden'); // Skrýt i novou sekci
                floatingNewAnalysisBtn.classList.add('hidden');
                floatingComparisonBtn.classList.add('hidden');
                floatingBackBtn.classList.add('hidden');
                floatingSolutionBtn.classList.add('hidden');
                floatingBackToComparisonBtn.classList.add('hidden'); // Skrýt i nové tlačítko
                const floatingWarningBar = $('#floating-warning-bar');
                floatingWarningBar.classList.add('hidden');
                floatingWarningBar.classList.remove('visible');

                welcomeScreen.classList.remove('hidden');
                
                welcomeScreen.style.opacity = 1;

                gmfInput.value = '';
                currentPlaceDetails = null;
                competitors = [];
                manualChecklistState = {};
                competitorsState = {};
                
                // Restore body overflow for analysis screen
                document.body.style.overflow = '';
            };

            // Přidán Event Listener pro plovoucí tlačítka
            floatingNewAnalysisBtn.addEventListener('click', resetToWelcomeScreen);
            
            floatingComparisonBtn.addEventListener('click', () => {
                analysisContainer.classList.add('hidden');
                competitorComparisonContainer.classList.remove('hidden');
                findAndRenderCompetitors(currentPlaceDetails);
                floatingComparisonBtn.classList.add('hidden');
                floatingBackBtn.classList.remove('hidden');
                floatingSolutionBtn.classList.remove('hidden');
                hideWarningBar();
            });
            
            floatingBackBtn.addEventListener('click', () => {
                competitorComparisonContainer.classList.add('hidden');
                analysisContainer.classList.remove('hidden');
                floatingComparisonBtn.classList.remove('hidden');
                floatingBackBtn.classList.add('hidden');
                floatingSolutionBtn.classList.add('hidden');
                updateVerificationStatus();
            });
            
            // --- LOGIKA PRO NOVÁ TLAČÍTKA ---
            floatingSolutionBtn.addEventListener('click', () => {
                competitorComparisonContainer.classList.add('hidden');
                solutionProposalContainer.classList.remove('hidden');
                
                floatingBackBtn.classList.add('hidden');
                floatingSolutionBtn.classList.add('hidden');
                floatingBackToComparisonBtn.classList.remove('hidden');

                renderSolutionProposal();
                hideWarningBar();
            });

            floatingBackToComparisonBtn.addEventListener('click', () => {
                solutionProposalContainer.classList.add('hidden');
                competitorComparisonContainer.classList.remove('hidden');

                floatingBackToComparisonBtn.classList.add('hidden');
                floatingBackBtn.classList.remove('hidden');
                floatingSolutionBtn.classList.remove('hidden');
            });

            const floatingWarningBar = $('#floating-warning-bar');
            const warningCloseBtn = floatingWarningBar.querySelector('.close-btn');
            warningCloseBtn.addEventListener('click', () => {
                floatingWarningBar.classList.add('hidden');
                floatingWarningBar.classList.remove('visible');
                floatingNewAnalysisBtn.style.bottom = '30px';   
                floatingComparisonBtn.style.bottom = '95px';
            });

            // --- HLAVNÍ FUNKCE ---
            const startAnalysisFlow = (placeId) => {
                if (!placeId) return;
                
                welcomeScreen.style.opacity = 0;
                setTimeout(() => {
                    welcomeScreen.classList.add('hidden');
                }, 500);

                // Allow scrolling for the analysis page
                document.body.style.overflow = 'auto';

                analysisContainer.innerHTML = '<div class="spinner"><i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary-color)"></i></div>';
                analysisContainer.classList.remove('hidden');
                competitorComparisonContainer.classList.add('hidden');
                solutionProposalContainer.classList.add('hidden'); // Skrýt při startu
                floatingNewAnalysisBtn.classList.remove('hidden');
                floatingComparisonBtn.classList.remove('hidden');
                
                placesService.getDetails({ placeId, fields: placeDetailsFields }, (details, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && details) {
                        currentPlaceDetails = details;
                        
                        analysisContainer.innerHTML = `
                            <div id="top-overview-panel" class="analysis-top-panel"></div>
                            <div class="analysis-layout">
                                <div id="auto-details-widget" class="analysis-widget"></div>
                                <div id="manual-analysis-widget" class="analysis-widget"></div>
                                <div id="score-widget" class="analysis-widget"></div>
                            </div>
                        `;
                        
                        renderTopPanel(details);
                        renderAutoDetailsWidget(details);
                        renderManualAnalysisWidget(details);
                        
                        updateVerificationStatus();
                        updateManualChecklistState();
                        recalculateAndRenderScore();

                        const claimedCheckbox = $('#check-claimed');
                        if (claimedCheckbox) {
                            claimedCheckbox.addEventListener('change', () => {
                                updateVerificationStatus();
                                updateManualChecklistState();
                                recalculateAndRenderScore();
                            });
                        }

                    } else {
                        showError('Nepodarilo sa načítať detaily firmy.');
                    }
                });
            };
            
            const showError = (message) => {
                analysisContainer.classList.add('hidden');
                competitorComparisonContainer.classList.add('hidden');
                welcomeScreen.classList.remove('hidden');
                welcomeScreen.style.opacity = 1;
                floatingNewAnalysisBtn.classList.add('hidden');   
                floatingComparisonBtn.classList.add('hidden');
            };

            function initializeGoogleAndAutocomplete() {
                if (!window.google || !window.google.maps || !window.google.maps.places) {
                    setTimeout(initializeGoogleAndAutocomplete, 100); return;
                }
                placesService = new google.maps.places.PlacesService($('#map-service-container'));
                streetViewService = new google.maps.StreetViewService();
                const autocomplete = new google.maps.places.Autocomplete(gmfInput, { types: ['establishment'], fields: ['place_id', 'name', 'formatted_address'] });
                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (place && place.place_id) startAnalysisFlow(place.place_id);
                });
            }
            
            const script = document.getElementById('google-maps-script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=places,geometry&language=sk&callback=initGoogleServices`;
            window.initGoogleServices = initializeGoogleAndAutocomplete;
            
            // --- VYKRESLOVACÍ FUNKCE (zůstávají beze změny) ---
            const renderTopPanel = (d) => {
                const photoUrl = d.photos && d.photos.length > 0
                    ? d.photos[0].getUrl({ maxWidth: 1024, maxHeight: 250 })
                    : 'https://placehold.co/1024x250/EAEAEA/B6B6B6?text=Fotografia+nie+je+dostupn%C3%A1';

                const placeName = encodeURIComponent(d.name);
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${placeName}&query_place_id=${d.place_id}`;
                const searchUrl = `https://www.google.com/search?q=${placeName}`;
                
                let businessStatusText = 'Neaktívne';
                let statusColor = 'var(--google-red)';
                let statusIcon = 'fa-eye-slash';

                if (d.business_status === 'OPERATIONAL') {
                    businessStatusText = 'Viditeľné';
                    statusColor = 'var(--google-green)';
                    statusIcon = 'fa-eye';
                } else if (d.business_status === 'CLOSED_TEMPORARILY') {
                    businessStatusText = 'Pozastavené';
                    statusColor = 'var(--google-yellow)';
                    statusIcon = 'fa-pause-circle';
                }

                $('#top-overview-panel').innerHTML = `
                    <div class="top-panel-background" style="background-image: url('${photoUrl}');"></div>
                    <div class="top-panel-content">
                        <div class="top-panel-header">
                            <div class="company-info">
                                <div class="company-details-group">
                                    <span id="verification-icon-container" class="fa-stack verified-icon">
                                        <i class="fas fa-shield-alt fa-stack-2x" id="shield-icon"></i>
                                        <i class="fas fa-times fa-stack-1x" id="status-icon" style="color:white;"></i>
                                    </span>
                                    <div id="company-details-box">
                                        <h2>${d.name || 'Neznámy podnik'}</h2>
                                        <div class="rating-info">
                                            <i class="fas fa-star"></i>
                                            <span>${d.rating?.toFixed(1) || 'N/A'}</span>
                                            <span style="margin-left:5px;">(${d.user_ratings_total || 0} recenzií)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="company-actions-block">
                                <div class="status-button" style="background-color: ${statusColor};">
                                    <i class="fas ${statusIcon}"></i>
                                    <span>${businessStatusText}</span>
                                </div>
                                <div class="company-actions">
                                    <a id="open-search-btn" class="btn" target="_blank" href="${searchUrl}"><i class="fas fa-search"></i> Google</a>
                                    <a id="open-maps-btn" class="btn" target="_blank" href="${mapsUrl}"><i class="fas fa-map-marker-alt"></i> Mapy</a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            };

            const renderAutoDetailsWidget = (d) => {
                const getData = (value, formatter) => {
                    const fallback = '<span class="missing">Chýba</span>';
                    if (value === null || typeof value === 'undefined' || value === '' || (Array.isArray(value) && value.length === 0)) return fallback;
                    if (typeof formatter === 'function') {
                        const result = formatter(value);
                        return result === null || result === '' ? fallback : result;
                    }
                    if (typeof value === 'boolean') return value ? '<span class="present">Áno</span>' : '<span class="missing">Nie</span>';
                    return value;
                };

                const formatPhotoCount = (photos) => {
                    if (!photos || photos.length === 0) {
                        return '<span class="missing">Chýba</span>';
                    }
                    const count = photos.length;
                    return count >= 10 ? '10+' : count;
                };

                const formatPriceLevel = (level) => {
                    switch (level) {
                        case 0: return 'Zdarma';
                        case 1: return 'Nízka';
                        case 2: return 'Stredná';
                        case 3: return 'Vysoká';
                        case 4: return 'Veľmi vysoká';
                        default: return null;
                    }
                };

                const openingHoursHtml = d.opening_hours?.weekday_text?.map(day => {
                    const parts = day.split(':');
                    const dayName = parts[0].trim();
                    const hours = parts.slice(1).join(':').trim();
                    return `<span>${dayName}:</span><span>${hours}</span>`;
                }).join('') || '<span class="missing">Chýba</span>';

                const hasReviews = d.reviews && d.reviews.length > 0;
                const hasGeometry = d.geometry && d.geometry.location;

                const hasStreetView = d.geometry && d.geometry.location;
                let hasStreetViewMessage = 'Chýba';

                if (hasStreetView) {
                    streetViewService.getPanorama({
                        location: d.geometry.location,
                        radius: 50,
                        source: google.maps.StreetViewSource.OUTDOOR
                    }, (data, status) => {
                        const streetViewToggleBtn = $('#street-view-toggle-btn');
                        if (!streetViewToggleBtn) return;
                        if (status === google.maps.StreetViewStatus.OK) {
                            streetViewToggleBtn.innerHTML = `<span>Zobraziť Street View</span><i class="fas fa-chevron-down"></i>`;
                            streetViewToggleBtn.disabled = false;
                        } else {
                            streetViewToggleBtn.innerHTML = `<span>Street View chýba</span><i class="fas fa-chevron-down"></i>`;
                            streetViewToggleBtn.disabled = true;
                        }
                    });
                }


                $('#auto-details-widget').innerHTML = `
                    <h3><i class="fas fa-cogs"></i> Fáza 1: Automatická analýza</h3>
                    <ul class="details-list">
                        <h4>Kategórie</h4>
                        <li><strong>Primárna kategória:</strong> <div class="value-col">${getData(d.types?.[0])?.replace(/_/g, ' ')}</div></li>
                        <li><strong>Sekundárne kategórie:</strong> <div class="value-col">${getData(d.types?.slice(1), arr => arr.map(i => i.replace(/_/g, ' ')).join(', '))}</div></li>
                        <h4>Kontaktné informácie</h4>
                        <li><strong>Adresa:</strong> <div class="value-col">${getData(d.formatted_address)}</div></li>
                        <li><strong>Web:</strong> <div class="value-col">${getData(d.website, url => `<a href="${url}" target="_blank">${url}</a>`)}</div></li>
                        <li><strong>Telefón:</strong> <div class="value-col">${getData(d.formatted_phone_number)}</div></li>
                        <li><strong>Plus Code:</strong> <div class="value-col">${getData(d.plus_code?.global_code)}</div></li>
                        <li>
                            <strong>Otváracie hodiny:</strong>
                            <div class="value-col">
                                <button type="button" class="toggle-btn" id="opening-hours-toggle">
                                    <span>${d.opening_hours?.weekday_text ? 'Zobraziť dni' : 'Chýba'}</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </li>
                        <li class="opening-hours-detail hidden">
                            <div class="opening-hours-grid">${openingHoursHtml}</div>
                        </li>
                        <li>
                            <strong>GPS lokácia:</strong>
                            <div class="value-col">
                                <button type="button" class="toggle-btn" id="map-toggle-btn">
                                    <span>${hasGeometry ? 'Zobraziť mapu' : 'Chýba'}</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </li>
                        <li class="map-detail hidden">
                            <div id="map" class="map-container"></div>
                        </li>
                        <li>
                            <strong>Street View:</strong>
                            <div class="value-col">
                                <button type="button" class="toggle-btn" id="street-view-toggle-btn">
                                    <span>Načítavam...</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </li>
                        <li class="street-view-detail hidden">
                            <div id="street-view-panorama" class="street-view-container"></div>
                        </li>
                        <h4>Hodnotenie</h4>
                        <li><strong>Priem. hodnotenie:</strong> <div class="value-col">${getData(d.rating, r => `<strong>${r} ★</strong>`)}</div></li>
                        <li><strong>Počet hodnotení:</strong> <div class="value-col">${getData(d.user_ratings_total)}</div></li>
                        <li>
                            <strong>Najnovšie recenzie:</strong>
                            <div class="value-col">
                                <button type="button" class="toggle-btn" id="reviews-toggle-btn">
                                    <span>Najnovšie</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </li>
                        <li class="reviews-list-container">
                            <div class="value-col" id="reviews-list"></div>
                        </li>
                        <h4>Obsah</h4>
                        <li><strong>Počet fotiek:</strong> <div class="value-col">${formatPhotoCount(d.photos)}</div></li>
                        <li><strong>Popis od vlastníka:</strong> <div class="value-col">${getData(d.editorial_summary?.overview)}</div></li>
                        <h4>Ostatné</h4>
                        <li><strong>Cenová úroveň:</strong> <div class="value-col">${getData(d.price_level, formatPriceLevel)}</div></li>
                        <li><strong>Bezbariérový vchod:</strong> <div class="value-col">${getData(d.wheelchair_accessible_entrance)}</div></li>
                    </ul>`;

                const openingHoursToggleBtn = $('#opening-hours-toggle');
                const openingHoursLi = $('#auto-details-widget .opening-hours-detail');
                const reviewsToggleBtn = $('#reviews-toggle-btn');
                const reviewsListContainer = $('.reviews-list-container');
                const reviewsList = $('#reviews-list');
                const reviews = d.reviews;
                const streetViewToggleBtn = $('#street-view-toggle-btn');
                const streetViewLi = $('.street-view-detail');
                let map;
                let panorama;

                if (streetViewToggleBtn && streetViewLi && hasGeometry) {
                    streetViewToggleBtn.addEventListener('click', () => {
                        streetViewLi.classList.toggle('hidden');
                        streetViewToggleBtn.classList.toggle('expanded');
                        const span = streetViewToggleBtn.querySelector('span');

                        if (!streetViewLi.classList.contains('hidden')) {
                            span.textContent = 'Skrýt Street View';
                            if (!panorama) {
                                panorama = new google.maps.StreetViewPanorama(
                                    document.getElementById('street-view-panorama'), {
                                        position: d.geometry.location,
                                        pov: { heading: 165, pitch: 0 },
                                        linksControl: true,
                                        panControl: true,
                                        zoomControl: true,
                                        enableCloseButton: false,
                                    });
                                panorama.setOptions({
                                    addressControl: false
                                });
                            }
                        } else {
                            span.textContent = 'Zobraziť Street View';
                        }
                    });
                } else if (streetViewToggleBtn) {
                    streetViewToggleBtn.innerHTML = `<span>Street View chybí</span><i class="fas fa-chevron-down"></i>`;
                    streetViewToggleBtn.disabled = true;
                }

                if (!reviews || reviews.length === 0) {
                    reviewsToggleBtn.innerHTML = '<span class="missing">Žádné recenze</span>';
                    reviewsToggleBtn.disabled = true;
                } else {
                    reviewsToggleBtn.addEventListener('click', () => {
                        reviewsListContainer.classList.toggle('show');
                        reviewsToggleBtn.classList.toggle('expanded');
                        
                        if (reviewsListContainer.classList.contains('show')) {
                            reviewsToggleBtn.querySelector('span').textContent = 'Skrýt recenze';
                            const sortedReviews = reviews.sort((a, b) => b.time - a.time).filter(r => r.text && r.text.trim() !== '').slice(0, 3);
                            let reviewsHtml = '';
                            sortedReviews.forEach(review => {
                                const date = new Date(review.time * 1000).toLocaleDateString('sk-SK');
                                const stars = '★'.repeat(Math.round(review.rating));
                                reviewsHtml += `
                                    <div class="review-card">
                                        <div class="review-header">
                                            <span class="review-author">${review.author_name}</span>
                                            <div class="review-rating">${stars}</div>
                                        </div>
                                        <div class="review-text">${review.text}</div>
                                        <div class="review-time">(${date})</div>
                                    </div>
                                `;
                            });
                            reviewsList.innerHTML = reviewsHtml;
                        } else {
                            reviewsToggleBtn.querySelector('span').textContent = 'Nejnovější';
                        }
                    });
                }


                if (openingHoursToggleBtn && openingHoursLi) {
                    openingHoursToggleBtn.addEventListener('click', () => {
                        openingHoursLi.classList.toggle('hidden');
                        openingHoursToggleBtn.classList.toggle('expanded');
                        const span = openingHoursToggleBtn.querySelector('span');
                        if (openingHoursLi.classList.contains('hidden')) {
                            span.textContent = 'Zobraziť dni';
                        } else {
                            span.textContent = 'Skrýt dny';
                        }
                    });
                }

                const mapToggleBtn = $('#map-toggle-btn');
                const mapLi = $('.map-detail');
                
                if (hasGeometry) {
                    mapToggleBtn.addEventListener('click', () => {
                        mapLi.classList.toggle('hidden');
                        mapToggleBtn.classList.toggle('expanded');
                        const span = mapToggleBtn.querySelector('span');
                        if (mapLi.classList.contains('hidden')) {
                            span.textContent = 'Zobraziť mapu';
                        } else {
                            span.textContent = 'Skrýt mapu';
                            if (!map) {
                                const mapElement = $('#map');
                                map = new google.maps.Map(mapElement, {
                                    center: d.geometry.location,
                                    zoom: 15
                                });
                                new google.maps.Marker({
                                    position: d.geometry.location,
                                    map: map,
                                    title: d.name
                                });
                            }
                            google.maps.event.trigger(map, 'resize');
                        }
                    });
                } else if (mapToggleBtn) {
                    mapToggleBtn.disabled = true;
                }
            };

            const updateManualChecklistState = () => {
                const checklist = $('#manual-checklist');
                if (!checklist) return;
                const checkboxes = checklist.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    manualChecklistState[cb.id] = cb.checked;
                });
                const reviewReplyBtn = $('#review-reply-btn');
                if (reviewReplyBtn) {
                    manualChecklistState['review-reply-btn'] = reviewReplyBtn.dataset.value;
                }
            };

            const renderManualAnalysisWidget = (d) => {
                $('#manual-analysis-widget').innerHTML = `
                    <div class="manual-header">
                        <h3><i class="fas fa-user-check"></i> Fáza 2: Manuálny audit</h3>
                    </div>
                    <div id="manual-checklist">
                        <div class="checklist-group">
                            <h4><i class="fas fa-key"></i> Základný stav profilu</h4>
                            <div class="check-item"><label for="check-claimed">Overený firemný zápis</label><input type="checkbox" id="check-claimed"></div>
                        </div>
                        <div class="checklist-group">
                            <h4><i class="fas fa-info-circle"></i> Informácie, konzistentnosť a pravidlá</h4>
                             <div class="check-item"><label for="check-primary-category">Primárna kategória</label><input type="checkbox" id="check-primary-category"></div>
                             <div class="check-item"><label for="check-secondary-categories">Sekundárne kategórie</label><input type="checkbox" id="check-secondary-categories"></div>
                             <div class="check-item"><label for="check-address">Adresa</label><input type="checkbox" id="check-address"></div>
                             <div class="check-item"><label for="check-website">Webové stránky</label><input type="checkbox" id="check-website"></div>
                             <div class="check-item"><label for="check-phone">Telefónne číslo</label><input type="checkbox" id="check-phone"></div>
                             <div class="check-item"><label for="check-hours">Otváracie hodiny</label><input type="checkbox" id="check-hours"></div>
                            <div class="check-item"><label for="check-name-spam">Názov firmy neobsahuje spam</label><input type="checkbox" id="check-name-spam"></div>
                            <div class="check-item"><label for="check-nap">Údaje (NAP) sú zhodné</label><input type="checkbox" id="check-nap"></div>
                        </div>
                        <div class="checklist-group">
                            <h4><i class="fas fa-image"></i> Kvalita obsahu</h4>
                            <div class="check-item"><label for="check-owner-photos">Fotky od majiteľa (Logo, titulná fotografia, ďalšie)</label><input type="checkbox" id="check-owner-photos"></div>
                            <div class="check-item"><label for="check-photos-10plus">Počet fotografií (viac ako 10)</label><input type="checkbox" id="check-photos-10plus"></div>
                            <div class="check-item"><label for="check-street-view">Profil obsahuje Google Street View</label><input type="checkbox" id="check-street-view"></div>
                            <div class="check-item"><label for="check-virtual-tour">Profil obsahuje Virtuálnu prehliadku</label><input type="checkbox" id="check-virtual-tour"></div>
                            <div class="check-item"><label for="check-drone-video">Profil obsahuje Dron</label><input type="checkbox" id="check-drone-video"></div>
                            <div class="check-item"><label for="check-video">Profil obsahuje Video</label><input type="checkbox" id="check-video"></div>
                            <div class="check-item"><label for="check-description">Vlastný popis firmy</label><input type="checkbox" id="check-description"></div>
                            <div class="check-item"><label for="check-attributes">Atribúty</label><input type="checkbox" id="check-attributes"></div>
                        </div>
                        <div class="checklist-group">
                            <h4><i class="fas fa-shopping-basket"></i> Produkty/Služby/Objednávky/Menu/Rezervácie</h4>
                            <div class="check-item"><label for="check-products">Vyplnená sekcia Produkty/Služby/Menu</label><input type="checkbox" id="check-products"></div>
                            <div class="check-item"><label for="check-services">Vyplnená sekcia Rezervácie/Objednávky</label><input type="checkbox" id="check-services"></div>
                        </div>
                        <div class="checklist-group">
                            <h4><i class="fas fa-bullhorn"></i> Reklamné novinky</h4>
                            <div class="check-item"><label for="check-posts">Aktívne príspevky</label><input type="checkbox" id="check-posts"></div>
                            <div class="check-item"><label for="check-posts-types">Aktivita príspevkov (menej ako 14 dní)</label><input type="checkbox" id="check-posts-types"></div>
                        </div>
                        <div class="checklist-group">
                            <h4><i class="fas fa-question-circle"></i> Otázky a odpovede (Q&A)</h4>
                            <div class="check-item"><label for="check-qa-owner-reply">Majiteľ odpovedá na otázky</label><input type="checkbox" id="check-qa-owner-reply"></div>
                        </div>
                        <div class="checklist-group">
                            <h4><i class="fas fa-users"></i> Interakcie</h4>
                            <div class="check-item">
                                <label for="check-review-reply">Reakcie na recenzie</label>
                                <div class="review-dropdown-wrapper">
                                    <button type="button" class="review-select-btn" id="review-reply-btn" data-value="0">
                                        <span>Nie</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <ul class="review-select-options">
                                        <li data-value="0">Nie</li>
                                        <li data-value="1">Čiastočne</li>
                                        <li data-value="2">Áno</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="check-item"><label for="check-messaging">Aktívne zasielanie správ (Chat)</label><input type="checkbox" id="check-messaging"></div>
                            <div class="check-item"><label for="check-whatsapp">Tlačidlo správ/Whatsapp</label><input type="checkbox" id="check-whatsapp"></div>
                        </div>
                    </div>`;
                
                const autoCheck = (id, condition) => {
                    const el = $(`#${id}`);
                    if (condition) {
                        el.checked = true;
                        el.disabled = true;
                    }
                };

                autoCheck('check-primary-category', d.types && d.types.length > 0);
                autoCheck('check-secondary-categories', d.types && d.types.length > 1);
                autoCheck('check-address', d.formatted_address);
                autoCheck('check-website', d.website);
                autoCheck('check-phone', d.formatted_phone_number);
                autoCheck('check-hours', d.opening_hours);
                autoCheck('check-photos-10plus', d.photos && d.photos.length >= 10);
                autoCheck('check-description', !!d.editorial_summary?.overview);


                $('#manual-checklist').addEventListener('change', () => {
                    updateManualChecklistState();
                    recalculateAndRenderScore();
                });
                
                const reviewReplyBtn = $('#review-reply-btn');
                const reviewReplyOptions = $('.review-select-options');
                
                reviewReplyBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    reviewReplyOptions.classList.toggle('show');
                    reviewReplyBtn.classList.toggle('expanded');
                });
                
                reviewReplyOptions.addEventListener('click', (e) => {
                    if (e.target.tagName === 'LI') {
                        const selectedValue = e.target.getAttribute('data-value');
                        const selectedText = e.target.textContent;
                        reviewReplyBtn.setAttribute('data-value', selectedValue);
                        reviewReplyBtn.querySelector('span').textContent = selectedText;
                        reviewReplyOptions.classList.remove('show');
                        reviewReplyBtn.classList.remove('expanded');
                        updateManualChecklistState();
                        recalculateAndRenderScore();
                    }
                });
                
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#review-reply-btn') && !e.target.closest('.review-select-options')) {
                        reviewReplyOptions.classList.remove('show');
                        reviewReplyBtn.classList.remove('expanded');
                    }
                });
            };
            
            const recalculateAndRenderScore = () => {
                if (!currentPlaceDetails) return;
                const { score, breakdown } = calculateScore(currentPlaceDetails, manualChecklistState, true);
                renderScoreWidget({ score, breakdown }, currentPlaceDetails);
            };

            const renderScoreWidget = ({ score, breakdown }, d) => {
                let scoreColor;
                if (score <= 40) { scoreColor = 'var(--score-red)'; }
                else if (score <= 75) { scoreColor = 'var(--score-orange)'; }
                else { scoreColor = 'var(--score-green)'; }
                
                const breakdownHtml = breakdown.map(item => `
                    <li class="${item.earned ? 'earned' : 'missed'}">
                        <i class="fas ${item.earned ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                        <span>${item.text}</span>
                    </li>`).join('');

                $('#score-widget').innerHTML = `
                    <h3><i class="fas fa-tachometer-alt"></i> Skóre optimalizácie</h3>
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div class="score-circle" style="background: conic-gradient(${scoreColor} ${score * 3.6}deg, #e9ecef ${score * 3.6}deg);">
                            <span class="score-value" style="color:${scoreColor}">${score}%</span>
                        </div>
                    </div>
                    <div class="score-breakdown">
                        <div class="score-breakdown-toggle">
                            <span>Prehľad hodnotenia</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="score-breakdown-list">
                            <ul>${breakdownHtml}</ul>
                        </div>
                    </div>`;

                const toggle = $('.score-breakdown-toggle');
                const list = $('.score-breakdown-list');

                toggle.addEventListener('click', () => {
                    list.classList.toggle('show');
                    toggle.classList.toggle('expanded');
                });
            };

            const updateVerificationStatus = () => {
                const claimedCheckbox = $('#check-claimed');
                const shieldIcon = $('#shield-icon');
                const statusIcon = $('#status-icon');
                const floatingWarningBar = $('#floating-warning-bar');
                if (!claimedCheckbox || !shieldIcon || !statusIcon || !floatingWarningBar) return;
                
                const updateIcon = (isVerified) => {
                    if (isVerified) {
                        shieldIcon.style.color = 'var(--google-green)';
                        statusIcon.classList.remove('fa-times');
                        statusIcon.classList.add('fa-check');
                        floatingWarningBar.classList.add('hidden');
                        floatingWarningBar.classList.remove('visible');
                        floatingNewAnalysisBtn.style.bottom = '30px';
                        floatingComparisonBtn.style.bottom = '95px';
                    } else {
                        shieldIcon.style.color = 'var(--google-red)';
                        statusIcon.classList.remove('fa-check');
                        statusIcon.classList.add('fa-times');
                        floatingWarningBar.classList.remove('hidden');
                        floatingWarningBar.classList.add('visible');
                        floatingNewAnalysisBtn.style.bottom = '320px';
                        floatingComparisonBtn.style.bottom = '385px';
                    }
                };
                updateIcon(claimedCheckbox.checked);
            };

            const initializeCompetitorState = (competitor) => {
                if (!competitorsState[competitor.place_id]) {
                    competitorsState[competitor.place_id] = {
                        'check-primary-category': competitor.types && competitor.types.length > 0,
                        'check-secondary-categories': competitor.types && competitor.types.length > 1,
                        'check-address': !!competitor.formatted_address,
                        'check-website': !!competitor.website,
                        'check-phone': !!competitor.formatted_phone_number,
                        'check-hours': !!competitor.opening_hours,
                        'check-claimed': false,
                        'check-name-spam': false,
                        'check-nap': false,
                        'check-owner-photos': false,
                        'check-photos-10plus': competitor.photos && competitor.photos.length >= 10,
                        'check-street-view': false,
                        'check-virtual-tour': false,
                        'check-drone-video': false,
                        'check-video': false,
                        'check-description': !!competitor.editorial_summary?.overview,
                        'check-attributes': false,
                        'check-products': false,
                        'check-services': false,
                        'check-posts': false,
                        'check-posts-types': false,
                        'check-qa-owner-reply': false,
                        'review-reply-btn': '0',
                        'check-messaging': false,
                        'check-whatsapp': false,
                    };
                }
            };

            const findAndRenderCompetitors = (mainCompany) => {
                competitorComparisonContainer.innerHTML = '<div class="spinner"><i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary-color)"></i></div>';

                const searchRequest = {
                    location: mainCompany.geometry.location,
                    radius: '5000',
                    type: mainCompany.types[0],
                };

                placesService.nearbySearch(searchRequest, async (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        const competitorPromises = results
                            .filter(p => p.place_id !== mainCompany.place_id)
                            .slice(0, MAX_COMPETITORS)
                            .map(p => new Promise(resolve => {
                                placesService.getDetails({ placeId: p.place_id, fields: placeDetailsFields }, (details, detailStatus) => {
                                    if (detailStatus === google.maps.places.PlacesServiceStatus.OK && details) {
                                        const distance = google.maps.geometry.spherical.computeDistanceBetween(
                                            mainCompany.geometry.location,
                                            details.geometry.location
                                        );
                                        details.distance = (distance / 1000).toFixed(1);
                                        resolve(details);
                                    } else {
                                        resolve(null);
                                    }
                                });
                            }));
                        competitors = (await Promise.all(competitorPromises)).filter(c => c);
                        competitors.forEach(c => initializeCompetitorState(c));
                    }
                    renderComparisonUI();
                });
            };

            const renderComparisonUI = () => {
                const container = $('#competitor-comparison-container');
                container.innerHTML = `
                    <div class="comparison-header">
                        <h3><i class="fas fa-chart-line"></i> Porovnanie s konkurenciou</h3>
                    </div>
                    <div class="competitor-add-container">
                        <div class="search-container">
                            <i class="fas fa-search"></i>
                            <input type="text" id="competitor-input" placeholder="Pridať ďalšieho konkurenta ručne...">
                        </div>
                        <button id="add-competitor-btn" class="btn" disabled><i class="fas fa-plus"></i> Pridať</button>
                    </div>
                    <div id="deep-audit-chart" class="chart-section"></div>
                    <div id="comparison-cards" class="comparison-cards-container"></div>
                    <div id="reviews-podium-chart" class="chart-section"></div>
                `;

                renderAllCardsAndCharts();
                setupCompetitorAutocomplete();
            };
            
            const showMainAnalysis = () => {
                competitorComparisonContainer.classList.add('hidden');
                analysisContainer.classList.remove('hidden');
                floatingComparisonBtn.classList.remove('hidden');
                floatingBackBtn.classList.add('hidden');
                floatingSolutionBtn.classList.add('hidden');
            };

            const renderAllCardsAndCharts = () => {
                const allCompanies = [currentPlaceDetails, ...competitors];
                const rankedCompanies = [...allCompanies]
                    .map(c => ({...c, score: calculateDeepAuditScore(c)}))
                    .sort((a,b) => b.score - a.score);

                const colorsMap = new Map(rankedCompanies.map((c, i) => [c.place_id, RANK_COLORS[i] || RANK_COLORS[3]]));

                const cardsHtml = allCompanies.map(c => renderCompetitorCard(c, c.place_id === currentPlaceDetails.place_id, colorsMap.get(c.place_id))).join('');
                $('#comparison-cards').innerHTML = cardsHtml;
                
                renderDeepAuditChart(rankedCompanies, colorsMap);
                renderReviewsPodiumChart(allCompanies, colorsMap);
            };

            const renderCompetitorCard = (c, isMain, color) => {
                const score = calculateDeepAuditScore(c);
                const state = isMain ? manualChecklistState : (competitorsState[c.place_id] || {});

                const getCheck = (id) => state[id] ? 'checked' : '';
                
                const getDisabledAttribute = (key) => {
                    if (isMain) {
                        return $(`#${key}`)?.disabled ? 'disabled' : '';
                    }
                    let initiallyPresent = false;
                    switch (key) {
                        case 'check-primary-category': initiallyPresent = c.types && c.types.length > 0; break;
                        case 'check-secondary-categories': initiallyPresent = c.types && c.types.length > 1; break;
                        case 'check-address': initiallyPresent = !!c.formatted_address; break;
                        case 'check-website': initiallyPresent = !!c.website; break;
                        case 'check-phone': initiallyPresent = !!c.formatted_phone_number; break;
                        case 'check-hours': initiallyPresent = !!c.opening_hours; break;
                        case 'check-photos-10plus': initiallyPresent = c.photos && c.photos.length >= 10; break;
                        case 'check-description': initiallyPresent = !!c.editorial_summary?.overview; break;
                    }
                    return initiallyPresent ? 'disabled' : '';
                };
                
                const placeName = encodeURIComponent(c.name);
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${placeName}&query_place_id=${c.place_id}`;
                const searchUrl = `https://www.google.com/search?q=${placeName}`;
                
                const getReplyState = () => {
                    const value = parseInt(state['review-reply-btn'] || 0);
                    if (value === 1) return { value: 1, text: 'Čiastočne' };
                    if (value === 2) return { value: 2, text: 'Áno' };
                    return { value: 0, text: 'Nie' };
                };
                const replyState = getReplyState();
                
                const fullChecklist = `
                    <div id="manual-checklist-${c.place_id}" style="flex-grow: 1;">
                         <div class="checklist-group">
                            <h4><i class="fas fa-key"></i> Základný stav</h4>
                            <div class="check-item"><label for="check-claimed-${c.place_id}">Overený zápis</label><input type="checkbox" id="check-claimed-${c.place_id}" ${getCheck('check-claimed')} ${getDisabledAttribute('check-claimed')}></div>
                        </div>
                        <div class="checklist-group">
                            <h4><i class="fas fa-info-circle"></i> Informácie, konzistentnosť a pravidlá</h4>
                            <div class="check-item"><label for="check-primary-category-${c.place_id}">Primárna kategória</label><input type="checkbox" id="check-primary-category-${c.place_id}" ${getCheck('check-primary-category')} ${getDisabledAttribute('check-primary-category')}></div>
                            <div class="check-item"><label for="check-secondary-categories-${c.place_id}">Sekundárne kategórie</label><input type="checkbox" id="check-secondary-categories-${c.place_id}" ${getCheck('check-secondary-categories')} ${getDisabledAttribute('check-secondary-categories')}></div>
                            <div class="check-item"><label for="check-address-${c.place_id}">Adresa</label><input type="checkbox" id="check-address-${c.place_id}" ${getCheck('check-address')} ${getDisabledAttribute('check-address')}></div>
                            <div class="check-item"><label for="check-website-${c.place_id}">Webové stránky</label><input type="checkbox" id="check-website-${c.place_id}" ${getCheck('check-website')} ${getDisabledAttribute('check-website')}></div>
                            <div class="check-item"><label for="check-phone-${c.place_id}">Telefónne číslo</label><input type="checkbox" id="check-phone-${c.place_id}" ${getCheck('check-phone')} ${getDisabledAttribute('check-phone')}></div>
                            <div class="check-item"><label for="check-hours-${c.place_id}">Otváracie hodiny</label><input type="checkbox" id="check-hours-${c.place_id}" ${getCheck('check-hours')} ${getDisabledAttribute('check-hours')}></div>
                            <div class="check-item"><label for="check-name-spam-${c.place_id}">Názov firmy neobsahuje spam</label><input type="checkbox" id="check-name-spam-${c.place_id}" ${getCheck('check-name-spam')} ${getDisabledAttribute('check-name-spam')}></div>
                            <div class="check-item"><label for="check-nap-${c.place_id}">Údaje (NAP) sú zhodné</label><input type="checkbox" id="check-nap-${c.place_id}" ${getCheck('check-nap')} ${getDisabledAttribute('check-nap')}></div>
                        </div>
                        <div class="checklist-group">
                            <h4><i class="fas fa-image"></i> Kvalita obsahu</h4>
                            <div class="check-item"><label for="check-owner-photos-${c.place_id}">Fotky od majiteľa</label><input type="checkbox" id="check-owner-photos-${c.place_id}" ${getCheck('check-owner-photos')} ${getDisabledAttribute('check-owner-photos')}></div>
                            <div class="check-item"><label for="check-photos-10plus-${c.place_id}">10+ fotografií</label><input type="checkbox" id="check-photos-10plus-${c.place_id}" ${getCheck('check-photos-10plus')} ${getDisabledAttribute('check-photos-10plus')}></div>
                            <div class="check-item"><label for="check-street-view-${c.place_id}">Google Street View</label><input type="checkbox" id="check-street-view-${c.place_id}" ${getCheck('check-street-view')} ${getDisabledAttribute('check-street-view')}></div>
                            <div class="check-item"><label for="check-virtual-tour-${c.place_id}">Virtuálna prehliadka</label><input type="checkbox" id="check-virtual-tour-${c.place_id}" ${getCheck('check-virtual-tour')} ${getDisabledAttribute('check-virtual-tour')}></div>
                            <div class="check-item"><label for="check-drone-video-${c.place_id}">Dron</label><input type="checkbox" id="check-drone-video-${c.place_id}" ${getCheck('check-drone-video')} ${getDisabledAttribute('check-drone-video')}></div>
                            <div class="check-item"><label for="check-video-${c.place_id}">Video</label><input type="checkbox" id="check-video-${c.place_id}" ${getCheck('check-video')} ${getDisabledAttribute('check-video')}></div>
                            <div class="check-item"><label for="check-description-${c.place_id}">Vlastný popis firmy</label><input type="checkbox" id="check-description-${c.place_id}" ${getCheck('check-description')} ${getDisabledAttribute('check-description')}></div>
                            <div class="check-item"><label for="check-attributes-${c.place_id}">Atribúty</label><input type="checkbox" id="check-attributes-${c.place_id}" ${getCheck('check-attributes')} ${getDisabledAttribute('check-attributes')}></div>
                        </div>
                        <div class="checklist-group">
                            <h4><i class="fas fa-shopping-basket"></i> Služby</h4>
                            <div class="check-item"><label for="check-products-${c.place_id}">Produkty/Služby/Menu</label><input type="checkbox" id="check-products-${c.place_id}" ${getCheck('check-products')} ${getDisabledAttribute('check-products')}></div>
                            <div class="check-item"><label for="check-services-${c.place_id}">Rezervácie/Objednávky</label><input type="checkbox" id="check-services-${c.place_id}" ${getCheck('check-services')} ${getDisabledAttribute('check-services')}></div>
                        </div>
                        <div class="checklist-group">
                            <h4><i class="fas fa-bullhorn"></i> Reklamné novinky</h4>
                            <div class="check-item"><label for="check-posts-${c.place_id}">Aktívne príspevky</label><input type="checkbox" id="check-posts-${c.place_id}" ${getCheck('check-posts')} ${getDisabledAttribute('check-posts')}></div>
                            <div class="check-item"><label for="check-posts-types-${c.place_id}">Aktivita < 14 dní</label><input type="checkbox" id="check-posts-types-${c.place_id}" ${getCheck('check-posts-types')} ${getDisabledAttribute('check-posts-types')}></div>
                        </div>
                        <div class="checklist-group">
                            <h4><i class="fas fa-question-circle"></i> Q&A</h4>
                            <div class="check-item"><label for="check-qa-owner-reply-${c.place_id}">Majiteľ odpovedá</label><input type="checkbox" id="check-qa-owner-reply-${c.place_id}" ${getCheck('check-qa-owner-reply')} ${getDisabledAttribute('check-qa-owner-reply')}></div>
                        </div>
                        <div class="checklist-group">
                            <h4><i class="fas fa-users"></i> Interakcie</h4>
                            <div class="check-item">
                                <label>Reakcie na recenzie</label>
                                <div class="review-dropdown-wrapper">
                                    <button type="button" class="review-select-btn" id="review-reply-btn-${c.place_id}" data-value="${replyState.value}">
                                        <span>${replyState.text}</span> <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <ul class="review-select-options">
                                        <li data-value="0">Nie</li> <li data-value="1">Čiastočne</li> <li data-value="2">Áno</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="check-item"><label for="check-messaging-${c.place_id}">Aktívny Chat</label><input type="checkbox" id="check-messaging-${c.place_id}" ${getCheck('check-messaging')} ${getDisabledAttribute('check-messaging')}></div>
                            <div class="check-item"><label for="check-whatsapp-${c.place_id}">Tlačidlo správ</label><input type="checkbox" id="check-whatsapp-${c.place_id}" ${getCheck('check-whatsapp')} ${getDisabledAttribute('check-whatsapp')}></div>
                        </div>
                    </div>`;

                return `
                    <div class="competitor-card ${isMain ? 'main-company' : ''}" data-place-id="${c.place_id}">
                        <div class="card-header">
                            <h4 style="color: ${color};">${c.name}</h4>
                            <div class="card-top-actions">
                                ${!isMain ? `
                                    <a class="card-action-btn" href="${searchUrl}" target="_blank" title="Hľadať na Google"><i class="fas fa-search"></i></a>
                                    <a class="card-action-btn" href="${mapsUrl}" target="_blank" title="Zobraziť na Mapách"><i class="fas fa-map-marker-alt"></i></a>
                                    <button class="remove-btn" title="Odobrať konkurenta" data-place-id="${c.place_id}">×</button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="rating-info">
                            <div>
                                <i class="fas fa-star"></i>
                                <span>${c.rating?.toFixed(1) || 'N/A'}</span>
                                <span style="font-weight: normal;">(${c.user_ratings_total || 0})</span>
                            </div>
                            ${!isMain && c.distance ? `<div style="font-weight: normal; font-size: 0.9em;"><i class="fas fa-route"></i> ${c.distance} km</div>` : ''}
                        </div>
                        <p style="font-size: 2em; font-weight: bold; color: ${color};">${score}%</p>
                        ${fullChecklist}
                    </div>
                `;
            };

            const renderDeepAuditChart = (rankedCompanies, colorsMap) => {
                let chartHtml = `<h3><i class="fas fa-chart-line"></i> Hĺbkový audit (Skóre)</h3>`;
                rankedCompanies.forEach(c => {
                    const color = colorsMap.get(c.place_id);
                    chartHtml += `
                        <div class="chart-bar-container">
                            <div class="chart-label" title="${c.name}">${c.name}</div>
                            <div class="chart-bar-wrapper">
                                <div class="chart-bar" style="width: ${c.score}%; background-color: ${color};">
                                    <span class="chart-score">${c.score}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                $('#deep-audit-chart').innerHTML = chartHtml;
            };
            
            const renderReviewsPodiumChart = (allCompanies, colorsMap) => {
                let chartHtml = `<h3><i class="fas fa-trophy"></i> Hodnotenie zákazníkov</h3>`;
                const rankedByReviews = [...allCompanies].sort((a,b) => (b.rating || 0) - (a.rating || 0) || (b.user_ratings_total || 0) - (a.user_ratings_total || 0));
                
                chartHtml += '<div class="podium-chart-container">';
                
                const medalIcons = ['fas fa-trophy', 'fas fa-medal', 'fas fa-medal'];
                const medalColors = ['#FFD700', '#C0C0C0', '#CD7F32'];

                const podiumStepsData = rankedByReviews.slice(0, 3).map((c, i) => ({ company: c, rank: i }));
                
                const finalPodiumOrder = [
                    podiumStepsData.find(d => d.rank === 1),
                    podiumStepsData.find(d => d.rank === 0),
                    podiumStepsData.find(d => d.rank === 2)
                ].filter(Boolean);

                finalPodiumOrder.forEach((stepData) => {
                    const { company, rank } = stepData;
                    const color = colorsMap.get(company.place_id);
                    const textColor = color === 'var(--google-yellow)' || color === '#86B386' ? 'var(--text-dark)' : 'white';

                    let podiumClass = '';
                    if (rank === 0) podiumClass = 'podium-1';
                    else if (rank === 1) podiumClass = 'podium-2';
                    else podiumClass = 'podium-3';

                    chartHtml += `
                        <div class="podium-step ${podiumClass}" style="background: ${color}; color: ${textColor};">
                            <div>
                                <i class="${medalIcons[rank]} podium-medal" style="color: ${medalColors[rank]};"></i>
                                <h4>${company.name}</h4>
                            </div>
                            <div class="podium-info">
                                ${company.rating?.toFixed(1) || 'N/A'} ★
                                <span class="review-count">(${company.user_ratings_total || 0} recenzií)</span>
                            </div>
                        </div>
                    `;
                });

                chartHtml += '</div>';
                $('#reviews-podium-chart').innerHTML = chartHtml;
            };
            
            const setupCompetitorAutocomplete = () => {
                const competitorInput = $('#competitor-input');
                const addCompetitorBtn = $('#add-competitor-btn');
                if (competitorInput) {
                    const autocomplete = new google.maps.places.Autocomplete(competitorInput, { types: ['establishment'], fields: ['place_id'] });
                    
                    autocomplete.addListener('place_changed', () => {
                        const place = autocomplete.getPlace();
                        if (place && place.place_id) {
                            addCompetitorBtn.disabled = false;
                            competitorInput.dataset.placeId = place.place_id;
                        } else {
                            addCompetitorBtn.disabled = true;
                            delete competitorInput.dataset.placeId;
                        }
                    });
                }
            };

            competitorComparisonContainer.addEventListener('click', (e) => {
                const addBtn = e.target.closest('#add-competitor-btn');
                if (addBtn) {
                    const competitorInput = $('#competitor-input');
                    const newCompetitorPlaceId = competitorInput.dataset.placeId;
                    if (newCompetitorPlaceId && competitors.length < MAX_COMPETITORS) {
                        placesService.getDetails({ placeId: newCompetitorPlaceId, fields: placeDetailsFields }, (details, status) => {
                            if (status === google.maps.places.PlacesServiceStatus.OK && details) {
                                // Ensure both places have geometry data AND geometry library is loaded
                                if (window.google && google.maps && google.maps.geometry && currentPlaceDetails?.geometry?.location && details?.geometry?.location) {
                                    const distance = google.maps.geometry.spherical.computeDistanceBetween(
                                        currentPlaceDetails.geometry.location,
                                        details.geometry.location
                                    );
                                    details.distance = (distance / 1000).toFixed(1);
                                }
                                competitors.push(details);
                                initializeCompetitorState(details);
                                competitorInput.value = '';
                                addBtn.disabled = true;
                                delete competitorInput.dataset.placeId;
                                renderAllCardsAndCharts();
                            }
                        });
                    }
                    return;
                }

                if (e.target.classList.contains('remove-btn')) {
                    const placeIdToRemove = e.target.dataset.placeId;
                    competitors = competitors.filter(c => c.place_id !== placeIdToRemove);
                    delete competitorsState[placeIdToRemove];
                    renderAllCardsAndCharts();
                    return;
                }

                const reviewBtn = e.target.closest('.review-select-btn');
                if (reviewBtn) {
                    e.stopPropagation();
                    const options = reviewBtn.nextElementSibling;
                    const isShowing = options.classList.contains('show');
                    $$('#competitor-comparison-container .review-select-options').forEach(o => o.classList.remove('show'));
                    $$('#competitor-comparison-container .review-select-btn').forEach(b => b.classList.remove('expanded'));
                    if (!isShowing) {
                        options.classList.add('show');
                        reviewBtn.classList.add('expanded');
                    }
                    return;
                }

                if (e.target.closest('.review-select-options') && e.target.tagName === 'LI') {
                    const card = e.target.closest('.competitor-card');
                    if (!card) return;
                    
                    const placeId = card.dataset.placeId;
                    const targetState = (placeId === currentPlaceDetails.place_id)
                        ? manualChecklistState
                        : competitorsState[placeId];

                    if (targetState) {
                        const value = e.target.dataset.value;
                        targetState['review-reply-btn'] = value;
                        renderAllCardsAndCharts();
                    }
                }
            });

            competitorComparisonContainer.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const card = e.target.closest('.competitor-card');
                    if (!card) return;

                    const placeId = card.dataset.placeId;
                    const targetState = (placeId === currentPlaceDetails.place_id)
                        ? manualChecklistState
                        : competitorsState[placeId];
                    
                    if (targetState) {
                        const key = e.target.id.replace(`-${placeId}`, '');
                        targetState[key] = e.target.checked;
                        renderAllCardsAndCharts();
                    }
                }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.review-dropdown-wrapper')) {
                    $$('.review-select-options').forEach(o => o.classList.remove('show'));
                    $$('.review-select-btn').forEach(b => b.classList.remove('expanded'));
                }
            });

            const calculateScore = (company, state, generateBreakdown = false) => {
                let score = 0;
                let maxScore = 0;
                const breakdown = [];

                const addPoints = (points, condition, text) => {
                    maxScore += points;
                    if (condition) {
                        score += points;
                        if(generateBreakdown) breakdown.push({ text, earned: true });
                    } else {
                        if(generateBreakdown) breakdown.push({ text, earned: false });
                    }
                };

                addPoints(15, state['check-claimed'], "Overený firemný zápis");
                addPoints(5, state['check-primary-category'], "Primárna kategória");
                addPoints(5, state['check-secondary-categories'], "Sekundárne kategórie");
                addPoints(5, state['check-address'], "Adresa");
                addPoints(5, state['check-website'], "Webové stránky");
                addPoints(5, state['check-phone'], "Telefónne číslo");
                addPoints(5, state['check-hours'], "Otváracie hodiny");
                addPoints(10, company.rating >= 4.0, "Hodnotenie 4.0 ★ a viac");
                addPoints(10, company.user_ratings_total >= 20, "Viac ako 20 recenzií");
                addPoints(5, state['check-photos-10plus'], "Má viac ako 10 fotografií");
                addPoints(5, state['check-owner-photos'], "Kvalitné fotky od majiteľa");
                addPoints(5, state['check-street-view'], "Profil obsahuje Google Street View");
                addPoints(5, state['check-virtual-tour'], "Existuje virtuálna prehliadka");
                addPoints(5, state['check-drone-video'], "Profil obsahuje Dron");
                addPoints(5, state['check-video'], "Profil obsahuje Video");
                addPoints(5, state['check-description'], "Vlastný popis firmy");
                addPoints(5, state['check-attributes'], "Vyplnené atribúty");
                addPoints(5, state['check-products'], "Vyplnená sekcia Produkty/Služby/Menu");
                addPoints(5, state['check-services'], "Vyplnená sekcia Rezervácie/Objednávky");
                addPoints(10, state['check-posts'], "Pravidelne publikuje príspevky");
                addPoints(5, state['check-posts-types'], "Aktivita príspevkov (menej ako 14 dní)");
                addPoints(5, state['check-qa-owner-reply'], "Odpovedá na otázky v Q&A");
                addPoints(5, state['check-messaging'], "Aktívne zasielanie správ (Chat)");
                addPoints(5, state['check-whatsapp'], "Tlačidlo správ/Whatsapp");
                addPoints(5, state['check-name-spam'], "Názov firmy bez spamu");
                addPoints(5, state['check-nap'], "Konzistentnosť údajov s webom (NAP)");

                maxScore += 10;
                const reviewReplyStatus = parseInt(state['review-reply-btn'] || '0');
                if (reviewReplyStatus === 2) {
                    score += 10;
                    if(generateBreakdown) breakdown.push({ text: "Reaguje na recenzie", earned: true });
                } else if (reviewReplyStatus === 1) {
                    score += 5;
                    if(generateBreakdown) breakdown.push({ text: "Reaguje na recenzie (čiastočne)", earned: true });
                } else {
                    if(generateBreakdown) breakdown.push({ text: "Nereaguje na recenzie", earned: false });
                }
                
                const finalScore = maxScore > 0 ? Math.round((score / maxScore) * 100) : 0;
                
                return {
                    score: finalScore,
                    breakdown: breakdown,
                };
            };

            const calculateDeepAuditScore = (company) => {
                const isMain = company.place_id === currentPlaceDetails.place_id;
                const state = isMain ? manualChecklistState : (competitorsState[company.place_id] || {});
                const { score } = calculateScore(company, state, false);
                return score;
            };

            // --- FUNKCE PRO VYKRESLENÍ NÁVRHU ŘEŠENÍ (S NOVÝMI TEXTY) ---
            const renderSolutionProposal = () => {
                const recommendations = [
                    // Kritické
                    {
                        id: 'check-claimed', critical: true, category: 'Kritické kroky', icon: 'fa-key', title: 'Overte si vlastníctvo firemného profilu',
                        why: 'Podľa Google majú overené profily <strong>2,7x vyššiu šancu</strong>, že ich zákazníci budú považovať za dôveryhodné. Bez overenia nemôžete spravovať kľúčové informácie a riskujete, že váš profil prevezme konkurencia alebo nespokojný zákazník.',
                        how: 'Proces overenia môže vyžadovať zaslanie kódu poštou alebo iné metódy. <strong>Zabezpečíme, aby celý proces prebehol hladko a rýchlo</strong>, a vy ste sa mohli čo najskôr plne venovať správe profilu.',
                        condition: (d, s) => !s['check-claimed']
                    },
                    // Základní informace
                     {
                        id: 'check-primary-category', category: 'Základné informácie', icon: 'fa-tags', title: 'Zvoľte správnu primárnu kategóriu',
                        why: 'Primárna kategória je najdôležitejší signál pre Google, čomu sa venujete. Správna voľba dramaticky zvyšuje šancu na zobrazenie relevantným zákazníkom, ktorí hľadajú presne vaše služby. Zlá kategória znamená, že sa ukazujete nesprávnym ľuďom.',
                        how: 'Na základe analýzy vášho biznisu a kľúčových slov vyberieme a nastavíme najpresnejšiu a najvýkonnejšiu primárnu kategóriu, ktorá maximalizuje vašu viditeľnosť v odbore.',
                        condition: (d, s) => !s['check-primary-category']
                    },
                    {
                        id: 'check-secondary-categories', category: 'Základné informácie', icon: 'fa-tags', title: 'Doplňte relevantné sekundárne kategórie',
                        why: 'Sekundárne kategórie umožňujú Google pochopiť celú šírku vašej ponuky. Každá ďalšia správne zvolená kategória je ako ďalšia sieť, ktorou chytáte nových zákazníkov hľadajúcich špecifické služby, ktoré ponúkate.',
                        how: 'Vykonáme detailnú rešerš a doplníme všetky relevantné vedľajšie kategórie, aby sme pokryli celý váš sortiment a služby a zabezpečili, že vám neunikne žiadny potenciálny zákazník.',
                        condition: (d, s) => !s['check-secondary-categories']
                    },
                    {
                        id: 'check-address', category: 'Základní informace', icon: 'fa-map-marker-alt', title: 'Zkontrolujte a optimalizujte adresu',
                        why: 'Přesná adresa a správně umístěný špendlík na mapě jsou klíčové pro funkci "Navigovat" a pro zákazníky, kteří vás chtějí fyzicky navštívit. Chyba v adrese může znamenat ztrátu zákazníka, který vás nenajde.',
                        how: 'Ověříme přesnost vaší adresy a pozice na mapě. Zajistíme, aby formát odpovídal standardům Googlu a poštovních služeb, což zlepší vaši důvěryhodnost pro algoritmus i pro zákazníky.',
                        condition: (d, s) => !s['check-address']
                    },
                    {
                        id: 'check-website', category: 'Základní informace', icon: 'fa-globe', title: 'Doplňte webové stránky',
                        why: 'Firmy s propojeným webem získávají v průměru o <strong>21-34 % více prokliků a dotazů</strong>. Váš web je centrem vaší online identity a Google profily s webem vnímá jako autoritativnější.',
                        how: 'Nejde jen o vložení odkazu. Propojíme váš profil s webem tak, aby měření návštěvnosti bylo přesné a abychom zajistili konzistenci klíčových informací (NAP), což je zásadní pro SEO. <strong>Postaráme se o technicky správné nastavení.</strong>',
                        condition: (d, s) => !s['check-website']
                    },
                    {
                        id: 'check-phone', category: 'Základní informace', icon: 'fa-phone', title: 'Přidejte telefonní číslo',
                        why: 'Možnost \'Click-to-Call\' z mobilního vyhledávání je jedním z nejčastějších způsobů konverze. Chybějící číslo znamená ztracené zákazníky, kteří se nebudou obtěžovat hledat jinde.',
                        how: 'Doplníme a zformátujeme číslo do správného mezinárodního tvaru, aby bylo funkční pro volání jedním klikem odkudkoliv. <strong>Zajistíme, aby vše fungovalo bezchybně.</strong>',
                        condition: (d, s) => !s['check-phone']
                    },
                    {
                        id: 'check-hours', category: 'Základní informace', icon: 'fa-clock', title: 'Vyplňte otevírací dobu',
                        why: 'Až <strong>40 % lokálních vyhledávání</strong> se týká dotazů na otevírací dobu. Neúplné informace odrazují zákazníky, kteří si vyberou konkurenci, u které mají jistotu, že je otevřeno.',
                        how: 'Správné nastavení otevírací doby, včetně speciálních hodin pro svátky, je klíčové. <strong>Můžeme za vás tuto agendu kompletně spravovat</strong>, abyste měli vždy aktuální informace bez starostí.',
                        condition: (d, s) => !s['check-hours']
                    },
                    {
                        id: 'check-name-spam', category: 'Základní informace', icon: 'fa-signature', title: 'Optimalizujte název firmy dle pravidel',
                        why: 'Google penalizuje profily, které v názvu používají klíčová slova navíc (tzv. "spam"). Čistý a správný název firmy bez přidaných klíčových slov zvyšuje důvěryhodnost a chrání vás před rizikem pozastavení profilu.',
                        how: 'Upravíme název vaší firmy tak, aby přesně odpovídal realitě a pravidlům Googlu. Klíčová slova strategicky umístíme tam, kam patří – do popisu, služeb a příspěvků.',
                        condition: (d, s) => !s['check-name-spam']
                    },
                    {
                        id: 'check-nap', category: 'Základní informace', icon: 'fa-check-double', title: 'Sjednoťte firemní údaje (NAP)',
                        why: 'Konzistence jména, adresy a telefonu (Name, Address, Phone - NAP) napříč internetem (váš web, katalogy, sociální sítě) je pro Google silným signálem důvěryhodnosti. Neshody v údajích poškozují vaši pozici ve vyhledávání.',
                        how: 'Provedeme audit vašich NAP údajů na internetu a zajistíme jejich sjednocení. Tato "čistá" digitální stopa je základem pro úspěšné lokální SEO.',
                        condition: (d, s) => !s['check-nap']
                    },
                    // Obsah a média
                    {
                        id: 'check-owner-photos', category: 'Obsah a média', icon: 'fa-camera-retro', title: 'Přidejte profesionální fotky od majitele',
                        why: 'Fotky od majitele (logo, titulní fotka, fotky interiéru/exteriéru) mají mnohem větší váhu než fotky od zákazníků. Profesionální vizuální prezentace je klíčová pro první dojem a budování značky.',
                        how: 'Zajistíme profesionální focení vašeho podniku. Vytvoříme sadu fotografií, které prodávají – od kvalitního loga, přes atraktivní titulní fotku až po snímky vašich prostor a produktů.',
                        condition: (d, s) => !s['check-owner-photos']
                    },
                    {
                        id: 'check-photos-10plus', category: 'Obsah a média', icon: 'fa-images', title: 'Přidejte více kvalitních fotografií (alespoň 10)',
                        why: 'Google uvádí, že profily s více než 10 kvalitními fotografiemi získávají <strong>o 42 % více žádostí o navigaci</strong> a <strong>o 35 % více prokliků na web</strong>. Vizuální obsah je dnes králem.',
                        how: 'Nestačí jen nahrát fotky z mobilu. Vytvoříme pro vás profesionální sadu fotografií, která ukáže váš podnik v nejlepším světle. <strong>Investice do profesionálních fotek se mnohonásobně vrací.</strong>',
                        condition: (d, s) => !s['check-photos-10plus']
                    },
                    {
                        id: 'check-street-view', category: 'Obsah a média', icon: 'fa-street-view', title: 'Propojte profil s Google Street View',
                        why: 'Aktuální a správně propojené Street View usnadňuje zákazníkům nalezení vaší firmy. Pokud snímky chybí nebo jsou zastaralé, může to působit nedůvěryhodně a odradit od návštěvy.',
                        how: 'Zajistíme aktualizaci snímků Street View před vaší provozovnou a jejich správné propojení s profilem. Vytvoříme pro vás profesionální 360° snímky, které vás dokonale představí.',
                        condition: (d, s) => !s['check-street-view']
                    },
                    {
                        id: 'check-virtual-tour', category: 'Obsah a média', icon: 'fa-vr-cardboard', title: 'Vytvořte virtuální prohlídku 360°',
                        why: 'Profily s virtuální prohlídkou mají dle Googlu <strong>dvojnásobnou šanci na zaujetí uživatele</strong>. Zákazníci si mohou váš podnik "projít" z pohodlí domova, což výrazně zvyšuje jejich důvěru a chuť vás navštívit.',
                        how: 'Jsme certifikovaní partneři Google pro tvorbu Street View a virtuálních prohlídek. Vytvoříme pro vás profesionální 360° prohlídku, kterou propojíme s vaším profilem a zajistíme maximální vizuální dopad.',
                        condition: (d, s) => !s['check-virtual-tour']
                    },
                    {
                        id: 'check-drone-video', category: 'Obsah a média', icon: 'fa-helicopter', title: 'Obohaťte profil o video z dronu',
                        why: 'Záběry z dronu představují vaši firmu z unikátní perspektivy a zanechávají silný dojem. Jsou ideální pro prezentaci rozsáhlejších areálů, hotelů, restaurací s venkovním posezením nebo realit.',
                        how: 'Zajistíme profesionální natáčení a postprodukci videa z dronu. Vytvoříme krátký, dynamický klip, který odliší váš profil od konkurence a zaujme na první pohled.',
                        condition: (d, s) => !s['check-drone-video']
                    },
                    {
                        id: 'check-video', category: 'Obsah a média', icon: 'fa-video', title: 'Přidejte do profilu prezentační video',
                        why: 'Video je nejefektivnější formát pro rychlé předání emocí a informací. Krátké video představující vaši firmu, služby nebo produkty udrží pozornost zákazníka déle než jakýkoliv text nebo obrázek.',
                        how: 'Vytvoříme pro vás profesionální krátké video optimalizované pro Google profil. Od scénáře, přes natáčení až po finální střih se postaráme o to, aby video prodávalo vaše služby.',
                        condition: (d, s) => !s['check-video']
                    },
                    {
                        id: 'check-description', category: 'Obsah a média', icon: 'fa-info-circle', title: 'Napište poutavý popis firmy',
                        why: 'Kvalitní popis je zásadní pro lokální SEO. Umožňuje nám strategicky umístit klíčová slova, díky kterým vás zákazníci najdou, i když nehledají přímo název vaší firmy.',
                        how: 'Napíšeme pro vás text, který bude nejen čtivý a přesvědčivý pro zákazníky, ale také optimalizovaný pro vyhledávací algoritmy Googlu. <strong>Využijte našich copywriterů a SEO specialistů.</strong>',
                        condition: (d, s) => !s['check-description']
                    },
                    {
                        id: 'check-attributes', category: 'Obsah a média', icon: 'fa-tasks', title: 'Doplňte specifické atributy',
                        why: 'Atributy (např. "Bezbariérový přístup", "Wi-Fi zdarma", "Možnost platit kartou") umožňují zákazníkům filtrovat výsledky vyhledávání. Pokud je nemáte vyplněné, nezobrazíte se zákazníkům, kteří hledají právě tyto vlastnosti.',
                        how: 'Projdeme s vámi všechny dostupné atributy pro vaši kategorii a pečlivě je vyplníme, aby váš profil odpovídal na co nejvíce specifických dotazů zákazníků.',
                        condition: (d, s) => !s['check-attributes']
                    },
                    // Interakce se zákazníky
                    {
                        id: 'reviews-10', category: 'Interakcie so zákazníkmi', icon: 'fa-star', title: 'Získajte viac ako 10 recenzií',
                        why: 'Podle studií si <strong>91 % zákazníků</strong> čte online recenze a <strong>84 %</strong> jim věří stejně jako osobnímu doporučení. Počet recenzí přímo ovlivňuje vaši pozici ve vyhledávání a důvěryhodnost.',
                        how: 'Víme, jak eticky a efektivně motivovat vaše zákazníky k zanechání hodnocení. <strong>Připravíme pro vás strategii a nástroje pro systematický sběr recenzí</strong>, které posunou váš profil na vrchol.',
                        condition: (d, s) => d.user_ratings_total < 10
                    },
                    {
                        id: 'rating-4.2', category: 'Interakce se zákazníky', icon: 'fa-star-half-alt', title: 'Zvyšte průměrné hodnocení nad 4.2 ★',
                        why: 'Průměrné hodnocení je jedním z prvních údajů, které zákazník vidí. Podle studií si firmy s hodnocením pod 4.0 hvězdičky vybírá jen minimum zákazníků. Zvýšení průměru i o desetiny bodu může výrazně zvýšit míru prokliku.',
                        how: 'Naše strategie pro sběr recenzí se zaměřuje na oslovování spokojených zákazníků, čímž přirozeně zvyšujeme průměrné hodnocení. Součástí je i profesionální řešení negativních recenzí.',
                        condition: (d, s) => d.rating < 4.2
                    },
                    {
                        id: 'review-reply-btn', category: 'Interakce se zákazníky', icon: 'fa-reply', title: 'Odpovídejte na všechny recenze',
                        why: 'Firmy, které odpovídají na recenze, jsou vnímány <strong>1.7x důvěryhodněji</strong> než ty, které nereagují. Google navíc aktivitu na profilu hodnotí jako pozitivní signál a zlepšuje vaši viditelnost.',
                        how: 'Pravidelné sledování a profesionální odpovídání na recenze je časově náročné. <strong>Tuto komunikaci převezmeme za vás</strong>, budeme reagovat rychle a v souladu s vaší firemní kulturou.',
                        condition: (d, s) => parseInt(s['review-reply-btn']) < 2
                    },
                     {
                        id: 'check-qa-owner-reply', category: 'Interakce se zákazníky', icon: 'fa-question-circle', title: 'Využijte sekci Otázky a odpovědi',
                        why: 'Proaktivní zodpovězení častých dotazů snižuje zátěž vašeho personálu a poskytuje zákazníkům okamžité informace. Je to také skvělá příležitost, jak do profilu dostat další relevantní klíčová slova.',
                        how: 'Analyzujeme, co vaši zákazníci nejčastěji hledají, a vytvoříme sadu strategických otázek a odpovědí (FAQ), které předejdou nejasnostem a zlepší vaši pozici ve vyhledávání. <strong>Nechte analytickou práci na nás.</strong>',
                        condition: (d, s) => !s['check-qa-owner-reply']
                    },
                    {
                        id: 'messaging-whatsapp', category: 'Interakce se zákazníky', icon: 'fa-comments', title: 'Aktivujte zasílání zpráv (Chat / WhatsApp)',
                        why: 'Moderní zákazníci preferují rychlou a neformální komunikaci. Možnost poslat rychlý dotaz přes chat může být rozhodujícím faktorem, proč si vyberou právě vás. Zvyšuje to engagement a počet poptávek.',
                        how: 'Aktivujeme a nastavíme pro vás funkci chatu. Můžeme zajistit i správu příchozích dotazů, abyste na žádný nezapomněli odpovědět včas, což je pro udržení dobrého hodnocení klíčové.',
                        condition: (d, s) => !s['check-messaging'] || !s['check-whatsapp']
                    },
                    // Pokročilé funkce
                    {
                        id: 'check-products', category: 'Pokročilé funkcie', icon: 'fa-shopping-basket', title: 'Doplňte produkty, služby alebo menu',
                        why: 'Zobrazení produktů a služeb přímo v profilu zkracuje nákupní proces. Zákazník nemusí chodit na web, aby zjistil, co nabízíte, což zvyšuje šanci na okamžitou akci.',
                        how: 'Profesionálně nafotíme a popíšeme vaše klíčové produkty či služby a vložíme je do profilu tak, aby byly pro zákazníky co nejatraktivnější. <strong>Postaráme se o kompletní prezentaci vaší nabídky.</strong>',
                        condition: (d, s) => !s['check-products']
                    },
                     {
                        id: 'check-services', category: 'Pokročilé funkce', icon: 'fa-calendar-check', title: 'Aktivujte Rezervace / Objednávky',
                        why: 'Přímé prolinkování na rezervační nebo objednávkový systém zkracuje zákazníkovi cestu ke konverzi. Google tuto funkci aktivně podporuje a profily s ní mají vyšší míru interakce.',
                        how: 'Propojíme váš profil s vaším stávajícím rezervačním systémem, nebo vám pomůžeme s implementací nového. Zajistíme, aby proces objednání byl pro zákazníka co nejjednodušší.',
                        condition: (d, s) => !s['check-services']
                    },
                    {
                        id: 'check-posts', category: 'Pokročilé funkce', icon: 'fa-bullhorn', title: 'Využívejte Příspěvky',
                        why: 'Příspěvky jsou jako bezplatná reklamní plocha přímo na Googlu. Umožňují komunikovat aktuální nabídky a novinky, což prokazatelně zvyšuje míru prokliku (CTR) a počet konverzí.',
                        how: 'Vytvoříme pro vás redakční plán a budeme pravidelně publikovat vizuálně atraktivní a textově poutavé příspěvky, které zaujmou a přivedou nové zákazníky. <strong>Ušetříme vám čas a zajistíme profesionální obsah.</strong>',
                        condition: (d, s) => !s['check-posts']
                    },
                     {
                        id: 'check-posts-types', category: 'Pokročilé funkce', icon: 'fa-history', title: 'Zvyšte aktivitu a frekvenci příspěvků',
                        why: 'Příspěvky na Google jsou platné pouze omezenou dobu. Pravidelná aktivita (alespoň jednou za 7-14 dní) je pro algoritmus signálem, že je váš profil živý a aktuální, což odměňuje lepší pozicí.',
                        how: 'Nemusíte se o nic starat. V rámci naší správy pro vás vytvoříme redakční plán a budeme pravidelně publikovat relevantní a poutavé příspěvky, které udrží váš profil na špici.',
                        condition: (d, s) => !s['check-posts-types']
                    }
                ];

                const activeRecommendations = recommendations.filter(rec => rec.condition(currentPlaceDetails, manualChecklistState));
                
                let html = `
                    <div class="solution-header">
                        <h2>Návrh riešenia pre ${currentPlaceDetails.name}</h2>
                        <p>Kroky, ktoré vám pomôžu dosiahnuť 100% potenciál vášho profilu.</p>
                    </div>
                `;

                if (activeRecommendations.length === 0) {
                    html += `
                        <div class="congrats-message">
                            <i class="fas fa-check-circle"></i>
                            <h2>Gratulujeme!</h2>
                            <p>Váš profil je vo skvelej kondícii! Nenašli sme žiadne zásadné nedostatky, ktoré by bolo treba okamžite riešiť.</p>
                        </div>
                    `;
                } else {
                    const grouped = activeRecommendations.reduce((acc, rec) => {
                        (acc[rec.category] = acc[rec.category] || []).push(rec);
                        return acc;
                    }, {});

                    const categoryOrder = ['Kritické kroky', 'Základné informácie', 'Obsah a médiá', 'Interakcie so zákazníkmi', 'Pokročilé funkcie'];

                    for (const category of categoryOrder) {
                        if (grouped[category]) {
                            html += `<div class="solution-category"><h3><i class="fas ${grouped[category][0].icon}"></i> ${category}</h3>`;
                            for (const rec of grouped[category]) {
                                html += `
                                    <div class="recommendation-card ${rec.critical ? 'critical' : ''}">
                                        <div class="recommendation-icon"><i class="fas ${rec.icon}"></i></div>
                                        <div class="recommendation-content">
                                            <h4 class="recommendation-title">${rec.title}</h4>
                                            <div class="why">
                                                <h4>Proč je to důležité?</h4>
                                                <p>${rec.why}</p>
                                            </div>
                                            <div class="how">
                                                <h4>Jak na to?</h4>
                                                <p>${rec.how}</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                            html += `</div>`;
                        }
                    }
                }
                
                solutionProposalContainer.innerHTML = html;
            };

        });
    </script>
</body>
</html>


